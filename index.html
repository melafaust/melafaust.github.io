<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps Insights Tool</title>
    <link href="https://fonts.googleapis.com/css?family=Exo:400,700" rel="stylesheet">
    <style>
        /* CSS Root Variables: Defines the color palette and sizing for the application. */
        :root {
            /* Default Theme Colors */
            --header-gradient-start: #4A0082;
            --header-gradient-end: #D4529D;
            --header-gradient-angle: 105deg; 
            --header-main-title-color: #FFFFFF;
            --page-bg-color: #F8F9FA; /* Will be less visible with dynamic background */
            --section-title-color: var(--header-gradient-start);
            --card-bg-color: #FFFFFF; 
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-border-radius: 8px;
            --card-title-color: var(--header-gradient-start);
            --card-icon-color: #8A3DAF;
            --text-color-dark: #333333;
            --link-color: var(--header-gradient-start);
            --button-primary-bg: var(--header-gradient-start);
            --button-primary-text-color: #FFFFFF;
            --button-primary-hover-bg: #3A006A;
            --input-bg: #ffffff;
            --input-border-color: #ced4da;
            --input-text-color: #495057;
            --danger-color: #dc3545;

            /* Calendar Specific Colors */
            --calendar-header-bg: #F3E8FA;
            --calendar-day-border: #D8BFD8;
            --calendar-day-hover-bg: #E8D9F2;
            --calendar-selected-day-bg: var(--header-gradient-end);
            --calendar-selected-day-text: #FFFFFF;
            --calendar-today-border-color: var(--header-gradient-start);
            --note-indicator-color: var(--header-gradient-end);
            --calendar-nav-button-color: var(--header-gradient-end);
            --calendar-nav-button-hover-color: var(--header-gradient-start);
            --calendar-month-year-color: var(--header-gradient-start);
            --calendar-weekdays-color: var(--header-gradient-start);

            /* Notepad Specific Colors */
            --notepad-heading-color: var(--header-gradient-start);
            --notes-item-rename-icon-color: var(--header-gradient-end);

            /* General UI Elements */
            --icon-button-size: 20px;
            --settings-icon-fill: #FFFFFF;

            /* Appearance Settings Variables (Page Background Image/Blur removed) */
            /* --page-background-image-url: url('https://placehold.co/1920x1080/7F00FF/FFFFFF?text=Background+Placeholder&font=roboto'); */
            /* --page-background-blur: 2px;  */
            
            --enable-translucency: 0; 
            --ui-element-base-color-rgb: 255, 255, 255; 
            --ui-element-opacity: 0.85; 
            --ui-element-backdrop-blur: 5px; 
            --ui-element-border-color: rgba(200, 200, 200, 0.3);

            /* Background Visualizer Specific - Initial minimal styling */
            --visualizer-settings-panel-bg: rgba(255, 255, 255, 0.8);
            --visualizer-settings-blur: 10px;
            --visualizer-settings-heading-color: #6A0DAD;
            --visualizer-settings-border-color: rgba(106, 13, 173, 0.25);
            --visualizer-input-border-color: rgba(106, 13, 173, 0.3);
            --visualizer-accent-color: #6A0DAD;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; } /* From backgroundsystem */

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--page-bg-color); 
            color: var(--text-color-dark);
            margin: 0; padding: 0; line-height: 1.65; overflow-x: hidden;
            box-sizing: border-box; position: relative; 
            /* overflow: hidden; from backgroundsystem - REMOVED as it breaks scrolling for devops.html */
        }

        /* REMOVED body::before for static background image */

        *, *:before, *:after { box-sizing: inherit; }

        /* Styles for Particle Canvas and Floating Boxes Area */
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        .area { width: 100%; height: 100vh; position: fixed; top: 0; left: 0; z-index: -1; display: none; }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .circles li { position: absolute; display: block; list-style: none; bottom: -200px; animation-name: animateBoxVisualizer; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes animateBoxVisualizer { 0% { transform: translateY(0) rotate(0deg); border-radius: 0; } 100% { transform: translateY(-1200px) rotate(720deg); opacity: 0 !important; border-radius: 50%; } }


        .top-header-wrapper {
            background: linear-gradient(var(--header-gradient-angle), var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-main-title-color); padding: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); position: relative; /* Ensure it's above background */
            z-index: 2; /* Make sure header is above visualizer */
            transition: background 0.3s ease; 
        }
        .top-header-content { width: 95%; max-width: 1100px; margin: 0 auto; text-align: center; display: flex; justify-content: center; align-items: center; position: relative; }
        .top-header-content h1 { font-size: 2rem; font-weight: 700; margin: 0; color: var(--header-main-title-color); flex-grow: 1; }

        #settings-button { background: none; border: none; color: var(--settings-icon-fill); cursor: pointer; padding: 8px; border-radius: 50%; transition: transform 0.3s ease-in-out, background-color 0.2s ease; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        #settings-button svg { width: 28px; height: 28px; fill: currentColor; }
        #settings-button:hover { transform: translateY(-50%) rotate(45deg); background-color: rgba(255, 255, 255, 0.15); }
        #settings-button:active { transform: translateY(-50%) rotate(45deg) scale(0.9); }
        
        .container { width: 95%; max-width: 1100px; margin: 30px auto; padding: 0 15px; position: relative; z-index: 1; /* Ensure content is above visualizer */ }
        .tools-title { font-size: 2rem; font-weight: 700; color: var(--section-title-color); margin-bottom: 30px; text-align: left; }
        .content-section { margin-bottom: 40px; }
        #programs-section > h2 { display: none; }
        #program-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 20px; margin-bottom: 20px; }

        .program-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px 15px; background-color: var(--card-bg-color); border: 1px solid #E9ECEF; border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease; text-decoration: none; min-height: 140px; }
        .program-item:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); }
        .program-item .item-icon { font-size: 2.4rem; color: var(--card-icon-color); margin-bottom: 15px; }
        .program-item .item-title { font-size: 1rem; font-weight: 700; color: var(--card-title-color); margin: 0; line-height: 1.35; }
      
        #program-explanation { padding: 20px; background-color: var(--card-bg-color); border: 1px solid #E9ECEF; border-radius: var(--card-border-radius); min-height: 70px; white-space: pre-wrap; font-style: italic; color: #555; box-shadow: var(--card-shadow); font-size: 0.95rem; margin-top: 20px; margin-bottom: 40px; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #program-explanation.active { font-style: normal; color: var(--text-color-dark); }

        #calendar-notes-section { background-color: var(--card-bg-color); padding: 25px; border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); transition: background-color 0.3s ease, border-color 0.3s ease; }
        #calendar-notes-section > h2 { margin-top: 0; color: var(--section-title-color); border-bottom: 2px solid var(--calendar-header-bg); padding-bottom: 12px; margin-bottom: 20px; font-size: 1.6rem; font-weight: 700; text-align: left; }

        #calendar-notes-container { display: flex; flex-wrap: wrap; gap: 25px; }
        #calendar-container { flex: 2 1 500px; display: flex; flex-direction: column; background-color: #fdfdff; border: 1px solid var(--calendar-day-border); border-radius: 6px; padding: 20px; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--calendar-header-bg); }
        #calendar-header button { background: none; border: none; color: var(--calendar-nav-button-color); font-size: 1.6rem; font-weight: 700; cursor: pointer; padding: 5px; transition: color 0.3s ease; }
        #calendar-header button:hover { color: var(--calendar-nav-button-hover-color); }
        #current-month-year { font-size: 1.45rem; font-weight: 700; color: var(--calendar-month-year-color); }
        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--calendar-weekdays-color); margin-bottom: 10px; font-size: 0.9rem; }
        #calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { position: relative; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; border: 1px solid var(--calendar-day-border); border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.1s ease; font-size: 0.95rem; font-weight: 500; }
        .calendar-day.inactive { color: #bbb; cursor: default; background-color: #f9f9f9 !important; } 
        .calendar-day:not(.inactive):hover { background-color: var(--calendar-day-hover-bg); border-color: var(--calendar-selected-day-bg); transform: scale(1.05); }
        .calendar-day.selected { background-color: var(--calendar-selected-day-bg); border-color: var(--calendar-selected-day-bg); color: var(--calendar-selected-day-text); font-weight: 700; transform: scale(1.05); }
        .calendar-day.today { border-color: var(--calendar-today-border-color); box-shadow: 0 0 0 2px var(--calendar-today-border-color); font-weight: 700; }
        .calendar-day .note-indicator { position: absolute; bottom: 4px; right: 4px; width: 8px; height: 8px; background-color: var(--note-indicator-color); border-radius: 50%; border: 1px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3); }

        #notes-container { flex: 1 1 300px; background-color: #fdfdff; border: 1px solid var(--calendar-day-border); border-radius: 6px; padding: 20px; display: flex; flex-direction: column; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        #notes-heading { margin: 0; color: var(--notepad-heading-color); font-size: 1.4rem; font-weight: 700; }
        #notes-buttons { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #create-note-btn, #save-all-notes-btn, #delete-all-notes-btn { border: none; padding: 9px 14px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.3s ease, transform 0.1s ease; outline: none; color: var(--button-primary-text-color); }
        #create-note-btn, #save-all-notes-btn { background-color: var(--button-primary-bg); }
        #delete-all-notes-btn { background-color: var(--danger-color); }
        #create-note-btn:hover, #save-all-notes-btn:hover { background-color: var(--button-primary-hover-bg); }
        #delete-all-notes-btn:hover { background-color: #c82333; }
        #create-note-btn:active, #save-all-notes-btn:active, #delete-all-notes-btn:active { transform: scale(0.98); } 

        #notes-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; } 
        .note-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid var(--calendar-day-border); cursor: pointer; transition: background-color 0.2s ease; position: relative; font-size: 1rem; }
        .note-item .note-name { flex-grow: 1; margin-right: 10px; color: var(--text-color-dark); font-weight: 600; }
        .note-item:last-child { border-bottom: none; } 
        .note-item:hover { background-color: var(--calendar-day-hover-bg); }
        .note-item .note-actions { display: flex; gap: 8px; } 
        .note-item .note-action-button { background: none; border: none; padding: 0; cursor: pointer; width: var(--icon-button-size); height: var(--icon-button-size); transition: transform 0.1s ease; position: relative; display: flex; align-items: center; justify-content: center; }
        .note-item .note-action-button svg { display: block; width: 75%; height: 75%; object-fit: contain; }
        .note-item .rename-button svg { fill: var(--notes-item-rename-icon-color); }
        .note-item .delete-button svg { fill: var(--danger-color); }
        .note-item .note-action-button:hover { transform: scale(1.15); } 
        .note-item .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-5px); background-color: var(--text-color-dark); color: #FFFFFF; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 10; }
        .note-item .note-action-button:hover .tooltip { opacity: 1; } 

        .translucent-ui .program-item,
        .translucent-ui #program-explanation,
        .translucent-ui #calendar-notes-section,
        .translucent-ui #calendar-container,
        .translucent-ui #notes-container,
        .translucent-ui .modal-content {
            background-color: rgba(var(--ui-element-base-color-rgb), var(--ui-element-opacity));
            backdrop-filter: blur(var(--ui-element-backdrop-blur));
            -webkit-backdrop-filter: blur(var(--ui-element-backdrop-blur)); 
            border: 1px solid var(--ui-element-border-color);
        }
        .translucent-ui .program-item .item-title,
        .translucent-ui #program-explanation,
        .translucent-ui #program-explanation.active,
        .translucent-ui #calendar-notes-section > h2,
        .translucent-ui #notes-heading,
        .translucent-ui .modal-content h3,
        .translucent-ui .modal-content,
        .translucent-ui .modal-content .input-group label {
            /* Example: color: #000000; */ 
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; } 
        .modal-content { background-color: var(--card-bg-color); padding: 30px; border-radius: var(--card-border-radius); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); max-width: 600px; width: 90%; transform: translateY(-20px); transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; color: var(--text-color-dark); max-height: 85vh; overflow-y: auto; }
        .modal-overlay.visible .modal-content { transform: translateY(0); } 
        .modal-content h3 { margin-top: 0; color: var(--header-gradient-start); font-size: 1.6rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid var(--calendar-header-bg); padding-bottom: 10px; }
        .modal-content .settings-section h4 { font-size: 1.2rem; color: var(--card-icon-color); margin-top: 20px; margin-bottom: 15px; }
        .modal-content .input-group { margin-bottom: 15px; }
        .modal-content .input-group label, .modal-content .control-row label, .modal-content .control-row .label-like  { display: block; margin-bottom: 6px; font-size: 0.95rem; font-weight: 600; }
        .modal-content input[type="text"], .modal-content input[type="color"], .modal-content input[type="url"], .modal-content input[type="number"], .modal-content textarea, .modal-content input[type="range"], .modal-content select { width: 100%; padding: 10px; margin-bottom: 10px; background-color: var(--input-bg); color: var(--input-text-color); border: 1px solid var(--input-border-color); border-radius: 5px; font-size: 1rem; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .modal-content input[type="color"] { padding: 5px; height: 40px; width: 50px; vertical-align: middle; margin-left: 5px;}
        .modal-content input[type="range"] { padding: 0; accent-color: var(--visualizer-accent-color); } 
        .modal-content input[type="text"]:focus, .modal-content input[type="color"]:focus, .modal-content input[type="url"]:focus, .modal-content input[type="number"]:focus, .modal-content textarea:focus, .modal-content input[type="range"]:focus, .modal-content select:focus { border-color: var(--card-icon-color); box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--card-icon-color) 25%, transparent); }
        .modal-content textarea { min-height: 180px; resize: vertical; } 
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .modal-buttons button { padding: 10px 18px; font-size: 0.95rem; font-weight: 600; border-radius: 5px; border: none; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; }
        .modal-buttons button:active { transform: scale(0.98); } 
        .modal-buttons button.primary { background-color: var(--button-primary-bg); color: var(--button-primary-text-color); }
        .modal-buttons button.primary:hover { background-color: var(--button-primary-hover-bg); }
        .modal-buttons button.cancel { background-color: #6c757d; color: var(--button-primary-text-color); }
        .modal-buttons button.cancel:hover { background-color: #5a6268; }
        .modal-buttons button.secondary { background-color: #adb5bd; color: var(--text-color-dark); }
        .modal-buttons button.secondary:hover { background-color: #9098a0; }

        .keybind-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px;}
        .keybind-input-group label { flex-basis: 220px; margin-bottom: 0; }
        .keybind-input-group input[type="text"] { flex-grow: 1; margin-bottom: 0; }

        #notes-list::-webkit-scrollbar, .modal-content::-webkit-scrollbar, .modal-content textarea::-webkit-scrollbar { width: 8px; }
        #notes-list::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track, .modal-content textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #notes-list::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb, .modal-content textarea::-webkit-scrollbar-thumb { background: var(--card-icon-color); border-radius: 10px; }
        #notes-list::-webkit-scrollbar-thumb:hover, .modal-content::-webkit-scrollbar-thumb:hover, .modal-content textarea::-webkit-scrollbar-thumb:hover { background: var(--header-gradient-start); }

        .notification-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 2000; max-width: 320px; }
        .notification { background-color: var(--header-gradient-start); color: var(--button-primary-text-color); padding: 14px 22px; border-radius: 6px; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); opacity: 0; transform: translateX(100%); animation: slideInFadeIn 0.4s ease-out forwards; }
        .notification.error { background-color: var(--danger-color); } 
        @keyframes slideInFadeIn { to { opacity: 1; transform: translateX(0); } } 
        @keyframes fadeOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .notification.fade-out { animation: fadeOutRight 0.4s ease-out forwards; }

        #import-drop-zone { border: 2px dashed var(--input-border-color); border-radius: var(--card-border-radius); padding: 25px; text-align: center; cursor: pointer; background-color: var(--page-bg-color); color: var(--text-color-dark); margin-top: 15px; transition: border-color 0.3s ease, background-color 0.3s ease; }
        #import-drop-zone p { margin: 0; font-size: 0.95rem; }
        #import-drop-zone.dragover { border-color: var(--header-gradient-end); background-color: color-mix(in srgb, var(--header-gradient-end) 10%, var(--page-bg-color)); }
        #import-notes-file-input { display: none; }

        .range-slider-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .range-slider-group label { flex-basis: 200px; margin-bottom: 0; }
        .range-slider-group input[type="range"] { flex-grow: 1; }
        .range-slider-group .range-value { min-width: 40px; text-align: right; font-size: 0.9em; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { margin-right: 5px; width: auto; transform: scale(1.1); }
        
        /* Styles for Background Visualizer Settings in Modal */
        .modal-content .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; }
        .modal-content .control-row label, .modal-content .control-row .label-like { margin-bottom: 0; flex-shrink: 0; margin-right: 10px; font-size:0.9rem; }
        .modal-content .control-row .input-value-pair { display: flex; align-items: center; flex-grow: 1; }
        .modal-content .control-row .input-value-pair input[type="range"], .modal-content .control-row .input-value-pair select { flex-grow: 1; width: calc(100% - 50px); margin-right: 10px;}
        .modal-content .control-row .value-display { display: inline-block; min-width: 40px; text-align: right; color: var(--visualizer-accent-color); font-weight: bold; font-size: 0.9rem; }
        .modal-content .conditional-setting { display: none; width: 100%; padding-left: 20px; margin-top: 8px; border-left: 2px solid var(--visualizer-accent-color); padding-top: 5px; margin-bottom:10px; }
        .modal-content .conditional-setting.visible { display: block; }
        .modal-content label.checkbox-label { display: inline; margin-bottom: 0; font-size: 0.9rem; }
        .modal-content .checkbox-group input[type="checkbox"] { accent-color: var(--visualizer-accent-color); }


        @media (max-width: 992px) {
             .top-header-content h1 { font-size: 1.7rem; } #settings-button { right: 10px; } #settings-button svg { width: 24px; height: 24px; }
             .tools-title { font-size: 1.6rem; } #program-menu { grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); }
             #calendar-notes-container { flex-direction: column; } #calendar-container, #notes-container { flex: none; width: 100%; } 
             .modal-content { padding: 20px; max-width: 90%; } .modal-content h3 { font-size: 1.4rem; }
             #notes-header { flex-direction: column; align-items: flex-start; } #notes-buttons { width: 100%; justify-content: flex-start; }
             .modal-buttons { flex-direction: column; gap: 8px; } .modal-buttons button { width: 100%; }
             .modal-content .control-row { flex-direction: column; align-items: flex-start; }
             .modal-content .control-row .input-value-pair { width: 100%; }
             .modal-content .control-row .input-value-pair input[type="range"], .modal-content .control-row .input-value-pair select { width: calc(100% - 50px); }
        }
         @media (max-width: 576px) {
              .top-header-content h1 { font-size: 1.5rem; } #settings-button { padding: 5px; } #settings-button svg { width: 22px; height: 22px; }
              .tools-title { font-size: 1.4rem; } #calendar-notes-section > h2 { font-size: 1.4rem; }
              #program-menu { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
              .program-item { padding: 15px 10px; min-height: 120px; } .program-item .item-icon { font-size: 2rem; margin-bottom: 8px;} .program-item .item-title { font-size: 0.9rem; }
              #calendar-container, #notes-container { padding: 15px; } .calendar-day { font-size: 0.85rem; }
              #notes-buttons button { width: auto; padding: 7px 10px; font-size: 0.85rem; } 
              .modal-content textarea { min-height: 120px; }
              .keybind-input-group { flex-direction: column; align-items: flex-start; } .keybind-input-group label { flex-basis: auto; }
              .range-slider-group { flex-direction: column; align-items: flex-start; } .range-slider-group label { flex-basis: auto; margin-bottom: 5px; }
         }
    </style>
</head>
<body class=""> 
    <canvas id="particleCanvas"></canvas>
    <div class="area" id="floatingBoxesArea"><ul class="circles" id="floatingBoxesList"></ul></div>

    <div class="top-header-wrapper">
        <div class="top-header-content">
            <h1>Azure DevOps Insights Tool</h1>
            <button id="settings-button" aria-label="Open Settings">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
    </div>

    <div class="container">
        <h2 class="tools-title">Tools</h2>
        <div id="programs-section" class="content-section"><div id="program-menu"></div></div>
        <div id="program-explanation"><p>Hover over a program card above to see its explanation here.</p></div>
        <div id="calendar-notes-section" class="content-section">
            <h2>Date Organizer</h2>
            <div id="calendar-notes-container">
                <div id="calendar-container">
                    <div id="calendar-header">
                        <button id="prev-month-btn" aria-label="Previous Month">&lt;</button>
                        <div id="current-month-year"></div>
                        <button id="next-month-btn" aria-label="Next Month">&gt;</button>
                    </div>
                    <div id="calendar-weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div id="calendar-days"></div>
                </div>
                <div id="notes-container">
                     <div id="notes-header">
                        <h3 id="notes-heading">Notepad</h3>
                         <div id="notes-buttons">
                            <button id="create-note-btn" style="display: none;">+ New Note</button>
                            <button id="delete-all-notes-btn" style="display: none;">Delete All</button>
                            <button id="save-all-notes-btn" style="display: none;">Save All</button> 
                         </div>
                     </div>
                    <ul id="notes-list"><li style="text-align: center; color: #777; font-style: italic; padding:10px 0;">Select a day to see or add notes.</li></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="name-note-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Name Your Note</h3>
            <input type="text" id="note-name-input" placeholder="Enter note filename...">
            <div class="modal-buttons"><button id="save-note-name-btn" class="primary">Create</button><button class="cancel" id="cancel-note-name-btn">Cancel</button></div>
        </div>
    </div>
    <div id="editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="editor-note-title">Note Editor</h3>
            <textarea id="note-editor-textarea" placeholder="Start writing..."></textarea>
            <div class="modal-buttons"><button id="save-note-content-btn" class="primary">Save</button><button id="copy-editor-content-btn" class="cancel">Copy to Clipboard</button><button class="cancel" id="close-editor-btn">Close</button></div>
        </div>
    </div>
    <div id="batch-count-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Batch Count Calculator Options</h3>
            <div class="modal-buttons" style="flex-direction: column; align-items: stretch;">
                <button id="batch-count-highest-btn" class="primary">Batch Count Highest Round</button>
                <button id="batch-count-nearest-btn" class="primary" style="margin-top:10px;">Batch Count Nearest Round</button>
                <button class="cancel" id="cancel-batch-count-btn" style="margin-top:20px;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Settings</h3>
            
            <div class="settings-section">
                <h4>Theme Customization (Header)</h4>
                <div class="input-group">
                    <label for="header-gradient-start-input">Header Gradient Start:</label>
                    <input type="color" id="header-gradient-start-input">
                </div>
                <div class="input-group">
                    <label for="header-gradient-end-input">Header Gradient End:</label>
                    <input type="color" id="header-gradient-end-input">
                </div>
                <div class="input-group">
                    <label for="header-gradient-angle-input">Header Gradient Angle (degrees):</label>
                    <input type="number" id="header-gradient-angle-input" min="0" max="360" step="1">
                </div>
                </div>

            <div class="settings-section">
                <h4>Appearance Settings (UI Elements)</h4>
                <div class="checkbox-group">
                    <input type="checkbox" id="enable-translucency-input">
                    <label for="enable-translucency-input">Enable Translucent UI Elements</label>
                </div>
                <div class="input-group">
                    <label for="ui-element-base-color-input">UI Element Base Color (for translucency):</label>
                    <input type="color" id="ui-element-base-color-input">
                </div>
                <div class="range-slider-group">
                    <label for="ui-element-opacity-input">UI Element Opacity:</label>
                    <input type="range" id="ui-element-opacity-input" min="0.1" max="1" step="0.01">
                    <span class="range-value" id="ui-element-opacity-value">1.0</span>
                </div>
                <div class="range-slider-group">
                    <label for="ui-element-backdrop-blur-input">UI Element Backdrop Blur:</label>
                    <input type="range" id="ui-element-backdrop-blur-input" min="0" max="20" step="1">
                    <span class="range-value" id="ui-element-backdrop-blur-value">0px</span>
                </div>
            </div>
            
            <div class="settings-section" id="background-visualizer-settings">
                <h4>Background Visualizer</h4>
                <h5>Particle Effect</h5>
                <div class="control-row"><label for="particleCount">Count:</label><div class="input-value-pair"><input type="range" id="particleCount"><span id="particleCountValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="particleSpeed">Speed:</label><div class="input-value-pair"><input type="range" id="particleSpeed" step="0.1"><span id="particleSpeedValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="particleSize">Max Size:</label><div class="input-value-pair"><input type="range" id="particleSize" step="0.5"><span id="particleSizeValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="particleColorScheme">Color Scheme:</label><div class="input-value-pair"><select id="particleColorScheme"><option value="vibrant">Vibrant (Purple/Orange)</option><option value="cool">Cool Tones (Blues/Cyans)</option><option value="warm">Warm Tones (Reds/Oranges)</option><option value="forest">Forest Tones (Greens/Browns)</option><option value="monochrome_particles">Monochrome (Grays/White)</option></select></div></div>
                <div class="control-row checkbox-group"><input type="checkbox" id="showLines"><label for="showLines" class="checkbox-label">Show Lines</label></div>
                <div class="control-row"><label for="lineDistance">Line Max Dist:</label><div class="input-value-pair"><input type="range" id="lineDistance"><span id="lineDistanceValue" class="value-display"></span></div></div>
                <div class="control-row checkbox-group"><input type="checkbox" id="wrapParticles"><label for="wrapParticles" class="checkbox-label">Wrap Particles at Edges</label></div>
                
                <h5>Mouse Interaction (Particles)</h5>
                <div class="control-row checkbox-group"><input type="checkbox" id="mouseRepel"><label for="mouseRepel" class="checkbox-label">Repel Particles</label></div>
                <div class="control-row"><label for="mouseRadius">Repel Radius:</label><div class="input-value-pair"><input type="range" id="mouseRadius"><span id="mouseRadiusValue" class="value-display"></span></div></div>

                <hr style="margin: 20px 0;">
                <h5>Floating Boxes Effect</h5>
                <div class="control-row checkbox-group"><input type="checkbox" id="toggleFloatingBoxes"><label for="toggleFloatingBoxes" class="checkbox-label">Enable Floating Boxes</label></div>
                <div class="control-row"><label for="boxCount">Count:</label><div class="input-value-pair"><input type="range" id="boxCount"><span id="boxCountValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="maxBoxSize">Max Size:</label><div class="input-value-pair"><input type="range" id="maxBoxSize"><span id="maxBoxSizeValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="boxOpacity">Opacity:</label><div class="input-value-pair"><input type="range" id="boxOpacity" step="0.05"><span id="boxOpacityValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="boxAnimationScale">Anim. Speed:</label><div class="input-value-pair"><input type="range" id="boxAnimationScale" step="0.1"><span id="boxAnimationScaleValue" class="value-display"></span></div></div>
                <div class="control-row"><label for="boxColorMode">Color Mode:</label><div class="input-value-pair"><select id="boxColorMode"><option value="theme_boxes">Theme Mix (Purple/Orange)</option><option value="monochrome_boxes">Monochrome</option><option value="solid_custom">Custom Solid</option><option value="gradient_custom">Custom Gradient</option></select></div></div>
                <div id="boxSolidColorControls" class="conditional-setting"><div class="control-row"><label for="boxSolidColor1" class="inline-label">Solid Color:</label><input type="color" id="boxSolidColor1"></div></div>
                <div id="boxGradientControls" class="conditional-setting">
                    <div class="control-row"><label for="boxGradientColor1" class="inline-label">Gradient Start:</label><input type="color" id="boxGradientColor1"></div>
                    <div class="control-row"><label for="boxGradientColor2" class="inline-label">Gradient End:</label><input type="color" id="boxGradientColor2"></div>
                    <div class="control-row"><label for="boxGradientDirection">Direction:</label><div class="input-value-pair"><select id="boxGradientDirection"><option value="to right">To Right</option><option value="to left">To Left</option><option value="to bottom">To Bottom</option><option value="to top">To Top</option><option value="to bottom right">To Bottom Right</option><option value="to top left">To Top Left</option><option value="45deg">Diagonal (45deg)</option><option value="-45deg">Diagonal (-45deg)</option></select></div></div>
                </div>
                <div class="control-row checkbox-group"><input type="checkbox" id="boxShadowsEnabled"><label for="boxShadowsEnabled" class="checkbox-label">Shadows</label></div>
                <div class="control-row checkbox-group"><input type="checkbox" id="boxBorderEnabled"><label for="boxBorderEnabled" class="checkbox-label">Border</label></div>
                <div id="boxBorderControls" class="conditional-setting">
                    <div class="control-row"><label for="boxBorderWidth">Border Width:</label><div class="input-value-pair"><input type="range" id="boxBorderWidth"><span id="boxBorderWidthValue" class="value-display"></span></div></div>
                    <div class="control-row"><label for="boxBorderColor" class="inline-label">Border Color:</label><input type="color" id="boxBorderColor"></div>
                </div>
                <div class="modal-buttons" style="justify-content: flex-start; margin-top: 15px;">
                    <button id="resetParticleSettingsBtn" class="secondary">Reset Particles</button>
                    <button id="resetBoxSettingsBtn" class="secondary">Reset Boxes</button>
                </div>
            </div>

            <div class="settings-section"> <div class="modal-buttons" style="margin-top:10px;">
                    <button id="apply-appearance-btn" class="primary">Apply All Appearance</button>
                    <button id="reset-appearance-btn" class="secondary">Reset All Appearance</button>
                </div>
            </div>


            <div class="settings-section">
                <h4>Data Management (Notepad)</h4>
                <div class="modal-buttons" style="justify-content: flex-start;">
                    <button id="export-notes-btn" class="primary">Export All Notes</button>
                </div>
                 <input type="file" id="import-notes-file-input" accept=".json" aria-label="Import notes file">
                 <div id="import-drop-zone" role="button" tabindex="0" aria-labelledby="import-drop-zone-label">
                    <p id="import-drop-zone-label">Drag & Drop your notes JSON file here, or click to select file.</p>
                    <p style="font-size:0.8em; opacity:0.7;">(Importing will overwrite existing notes)</p>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-color-dark); opacity: 0.8; margin-top:10px;">
                    Export all your notepad data as a JSON file. You can import this file later to restore your notes.
                    <strong>Warning:</strong> Importing will overwrite any current notes in the application.
                </p>
            </div>

            <div class="settings-section">
                <h4>Keybinds</h4>
                <p style="font-size: 0.85rem; color: var(--text-color-dark); opacity: 0.8; margin-bottom:15px;">
                    Define keyboard shortcuts. Use keys like 'N', '1', or with modifiers: 'Alt+1', 'Control+S', 'Control+ArrowLeft'.
                    Avoid single letters if they conflict with typing in input fields.
                </p>
                <h5>Global & Tool Launching</h5>
                <div class="keybind-input-group"><label for="keybind-param-extractor">Parameter Extractor:</label><input type="text" id="keybind-param-extractor" placeholder="e.g., Alt+1"></div>
                <div class="keybind-input-group"><label for="keybind-batch-calculator">Batch Count Calculator:</label><input type="text" id="keybind-batch-calculator" placeholder="e.g., Alt+2"></div>
                <div class="keybind-input-group"><label for="keybind-csv-to-json">CSV to JSON Processor:</label><input type="text" id="keybind-csv-to-json" placeholder="e.g., Alt+3"></div>
                <div class="keybind-input-group"><label for="keybind-tool4">Tool 4 (Future):</label><input type="text" id="keybind-tool4" placeholder="e.g., Alt+4"></div>
                <div class="keybind-input-group"><label for="keybind-tool5">Tool 5 (Future):</label><input type="text" id="keybind-tool5" placeholder="e.g., Alt+5"></div>
                <div class="keybind-input-group"><label for="keybind-open-settings">Open Settings:</label><input type="text" id="keybind-open-settings" placeholder="e.g., Alt+O"></div>
                <h5>Date Organizer - Calendar</h5>
                <div class="keybind-input-group"><label for="keybind-prev-month">Previous Month:</label><input type="text" id="keybind-prev-month" placeholder="e.g., Control+ArrowLeft"></div>
                <div class="keybind-input-group"><label for="keybind-next-month">Next Month:</label><input type="text" id="keybind-next-month" placeholder="e.g., Control+ArrowRight"></div>
                <div class="keybind-input-group"><label for="keybind-goto-today">Go to Today:</label><input type="text" id="keybind-goto-today" placeholder="e.g., Control+T"></div>
                <h5>Date Organizer - Notepad (Day Selected)</h5>
                <div class="keybind-input-group"><label for="keybind-new-note">New Note:</label><input type="text" id="keybind-new-note" placeholder="e.g., N"></div>
                <div class="keybind-input-group"><label for="keybind-delete-all-notes">Delete All Notes (Selected Day):</label><input type="text" id="keybind-delete-all-notes" placeholder="e.g., Control+Shift+Delete"></div>
                <h5>Date Organizer - Note Editor (Modal Open)</h5>
                <div class="keybind-input-group"><label for="keybind-save-note">Save Current Note:</label><input type="text" id="keybind-save-note" placeholder="e.g., Control+S"></div>
                <div class="modal-buttons"><button id="save-keybinds-btn" class="primary">Save Keybinds</button><button id="reset-keybinds-btn" class="secondary">Reset Keybinds</button></div>
            </div>
            
            <div class="modal-buttons" style="margin-top: 30px;"><button class="cancel" id="close-settings-btn">Close Settings</button></div>
        </div>
    </div>

    <div id="notification-container" class="notification-container"></div>

    <script>
        // --- Global Variables & DOM Element References (condensed for brevity) ---
        const calendarDaysGrid = document.getElementById('calendar-days'); const currentMonthYearDisplay = document.getElementById('current-month-year'); const prevMonthBtn = document.getElementById('prev-month-btn'); const nextMonthBtn = document.getElementById('next-month-btn'); const notesList = document.getElementById('notes-list'); const notesHeading = document.getElementById('notes-heading'); const createNoteBtn = document.getElementById('create-note-btn'); const deleteAllNotesBtn = document.getElementById('delete-all-notes-btn'); const saveAllNotesBtn = document.getElementById('save-all-notes-btn'); const nameNoteModal = document.getElementById('name-note-modal'); const noteNameInput = document.getElementById('note-name-input'); const saveNoteNameBtn = document.getElementById('save-note-name-btn'); const cancelNoteNameBtn = document.getElementById('cancel-note-name-btn'); const editorModal = document.getElementById('editor-modal'); const editorNoteTitle = document.getElementById('editor-note-title'); const noteEditorTextarea = document.getElementById('note-editor-textarea'); const saveNoteContentBtn = document.getElementById('save-note-content-btn'); const copyEditorContentBtn = document.getElementById('copy-editor-content-btn'); const closeEditorBtn = document.getElementById('close-editor-btn'); const programExplanation = document.getElementById('program-explanation'); const programMenu = document.getElementById('program-menu'); const batchCountModal = document.getElementById('batch-count-modal'); const batchCountHighestBtn = document.getElementById('batch-count-highest-btn'); const batchCountNearestBtn = document.getElementById('batch-count-nearest-btn'); const cancelBatchCountBtn = document.getElementById('cancel-batch-count-btn'); const settingsButton = document.getElementById('settings-button'); const settingsModal = document.getElementById('settings-modal'); const closeSettingsBtn = document.getElementById('close-settings-btn');
        const headerGradientStartInput = document.getElementById('header-gradient-start-input'); const headerGradientEndInput = document.getElementById('header-gradient-end-input'); const headerGradientAngleInput = document.getElementById('header-gradient-angle-input');
        // ApplyThemeBtn and ResetThemeBtn removed as their functionality is merged
        
        // Page BG Image/Blur inputs removed
        const enableTranslucencyInput = document.getElementById('enable-translucency-input'); const uiElementBaseColorInput = document.getElementById('ui-element-base-color-input'); const uiElementOpacityInput = document.getElementById('ui-element-opacity-input'); const uiElementOpacityValueDisplay = document.getElementById('ui-element-opacity-value'); const uiElementBackdropBlurInput = document.getElementById('ui-element-backdrop-blur-input'); const uiElementBackdropBlurValueDisplay = document.getElementById('ui-element-backdrop-blur-value'); const applyAppearanceBtn = document.getElementById('apply-appearance-btn'); const resetAppearanceBtn = document.getElementById('reset-appearance-btn');
        
        const exportNotesBtn = document.getElementById('export-notes-btn'); const importDropZone = document.getElementById('import-drop-zone'); const importNotesFileInput = document.getElementById('import-notes-file-input');
        const keybindParamExtractorInput = document.getElementById('keybind-param-extractor'); const keybindBatchCalculatorInput = document.getElementById('keybind-batch-calculator'); 
        const keybindCsvToJsonInput = document.getElementById('keybind-csv-to-json'); // Added for new tool
        const keybindTool4Input = document.getElementById('keybind-tool4'); const keybindTool5Input = document.getElementById('keybind-tool5'); const keybindOpenSettingsInput = document.getElementById('keybind-open-settings'); const keybindPrevMonthInput = document.getElementById('keybind-prev-month'); const keybindNextMonthInput = document.getElementById('keybind-next-month'); const keybindGotoTodayInput = document.getElementById('keybind-goto-today'); const keybindNewNoteInput = document.getElementById('keybind-new-note'); const keybindDeleteAllNotesInput = document.getElementById('keybind-delete-all-notes'); const keybindSaveNoteInput = document.getElementById('keybind-save-note'); const saveKeybindsBtn = document.getElementById('save-keybinds-btn'); const resetKeybindsBtn = document.getElementById('reset-keybinds-btn');

        // --- Background Visualizer DOM Elements ---
        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas.getContext('2d');
        const floatingBoxesArea = document.getElementById('floatingBoxesArea');
        const floatingBoxesList = document.getElementById('floatingBoxesList');

        const visControls = {
            particleCountSlider: document.getElementById('particleCount'), particleCountValue: document.getElementById('particleCountValue'),
            particleSpeedSlider: document.getElementById('particleSpeed'), particleSpeedValue: document.getElementById('particleSpeedValue'),
            particleSizeSlider: document.getElementById('particleSize'), particleSizeValue: document.getElementById('particleSizeValue'),
            particleColorSchemeSelect: document.getElementById('particleColorScheme'),
            showLinesCheckbox: document.getElementById('showLines'),
            lineDistanceSlider: document.getElementById('lineDistance'), lineDistanceValue: document.getElementById('lineDistanceValue'),
            wrapParticlesCheckbox: document.getElementById('wrapParticles'),
            mouseRepelCheckbox: document.getElementById('mouseRepel'),
            mouseRadiusSlider: document.getElementById('mouseRadius'), mouseRadiusValue: document.getElementById('mouseRadiusValue'),
            toggleFloatingBoxesCheckbox: document.getElementById('toggleFloatingBoxes'),
            boxCountSlider: document.getElementById('boxCount'), boxCountValue: document.getElementById('boxCountValue'),
            maxBoxSizeSlider: document.getElementById('maxBoxSize'), maxBoxSizeValue: document.getElementById('maxBoxSizeValue'),
            boxOpacitySlider: document.getElementById('boxOpacity'), boxOpacityValue: document.getElementById('boxOpacityValue'),
            boxAnimationScaleSlider: document.getElementById('boxAnimationScale'), boxAnimationScaleValue: document.getElementById('boxAnimationScaleValue'),
            boxColorModeSelect: document.getElementById('boxColorMode'),
            boxSolidColorControlsDiv: document.getElementById('boxSolidColorControls'), boxSolidColor1Input: document.getElementById('boxSolidColor1'),
            boxGradientControlsDiv: document.getElementById('boxGradientControls'),
            boxGradientColor1Input: document.getElementById('boxGradientColor1'), boxGradientColor2Input: document.getElementById('boxGradientColor2'),
            boxGradientDirectionSelect: document.getElementById('boxGradientDirection'),
            boxShadowsCheckbox: document.getElementById('boxShadowsEnabled'),
            boxBorderEnabledCheckbox: document.getElementById('boxBorderEnabled'),
            boxBorderControlsDiv: document.getElementById('boxBorderControls'),
            boxBorderWidthSlider: document.getElementById('boxBorderWidth'), boxBorderWidthValue: document.getElementById('boxBorderWidthValue'),
            boxBorderColorInput: document.getElementById('boxBorderColor'),
            resetParticleSettingsBtn: document.getElementById('resetParticleSettingsBtn'),
            resetBoxSettingsBtn: document.getElementById('resetBoxSettingsBtn')
        };


        let currentMonth = new Date().getMonth(); let currentYear = new Date().getFullYear();
        let selectedDate = null; let notesData = {}; 

        const NOTES_STORAGE_KEY = 'adoInsightsToolNotes_v8_settings';
        const APPEARANCE_STORAGE_KEY = 'adoInsightsToolAppearance_v3_visualizer'; // Incremented version
        const KEYBINDS_STORAGE_KEY = 'adoInsightsToolKeybinds_v2'; // Keep version or increment if structure changes significantly
        const NOTIFICATION_FADE_DURATION = 400;

        // --- Background Visualizer Default Settings & Data ---
        const defaultBackgroundVisualizerSettings = {
            particleCount: 150, particleSpeedFactor: 0.5, maxParticleSize: 3.0, particleColorScheme: 'vibrant', showLines: true, lineMaxDistance: 80, wrapParticles: true,
            mouseRepelEnabled: true, mouseRepelRadius: 100,
            floatingBoxesEnabled: true, boxCount: 15, minBoxSize: 20, maxBoxSize: 120, boxOpacity: 0.4, boxAnimationScale: 1.0, boxColorMode: 'gradient_custom', boxSolidColor1: '#6A0DAD', boxGradientColor1: '#9600ff', boxGradientColor2: '#ffc864', boxGradientDirection: '45deg', boxShadowsEnabled: true, boxBorderEnabled: false, boxBorderWidth: 2, boxBorderColor: '#FFFFFF',
        };
        const particleColorPalettes = {
            vibrant: ['#6A0DAD', '#8A2BE2', '#FFA500', '#FFDAB9', '#FFFFFF'], cool: ['#0077BE', '#00AADE', '#73C2FB', '#BCE3FF', '#FFFFFF'], warm: ['#D22B2B', '#FF8C00', '#FFD700', '#FFFACD', '#FFE4B5'], forest: ['#228B22', '#556B2F', '#8FBC8F', '#90EE90', '#F5F5DC'], monochrome_particles: ['#333333', '#666666', '#999999', '#CCCCCC', '#FFFFFF']
        };
        
        let particlesArray = [];
        const mouseForParticles = { x: null, y: null, radius: 100 }; // Renamed to avoid conflict if 'mouse' is used elsewhere
        let animationFrameIdVisualizer;


        const DEFAULT_APPEARANCE = {
            headerGradientStart: '#4A0082', headerGradientEnd: '#D4529D', headerGradientAngle: 105,
            // pageBgImageUrl and pageBgBlur removed
            enableTranslucency: false,
            uiElementBaseColor: '#FFFFFF', uiElementOpacity: 0.85, uiElementBackdropBlur: 5,
            backgroundVisualizer: { ...defaultBackgroundVisualizerSettings } // Added visualizer defaults
        };
        let currentAppearanceSettings = JSON.parse(JSON.stringify(DEFAULT_APPEARANCE)); // Deep copy

        const DEFAULT_KEYBINDS = { 
            paramExtractor: 'Alt+1', 
            batchCalculator: 'Alt+2', 
            csvToJson: 'Alt+3', // New tool's keybind
            tool4: 'Alt+4', 
            tool5: 'Alt+5', 
            openSettings: 'Alt+O', 
            prevMonth: 'Control+ArrowLeft', 
            nextMonth: 'Control+ArrowRight', 
            gotoToday: 'Control+T', 
            newNote: 'N', 
            deleteAllNotes: 'Control+Shift+Delete', 
            saveNote: 'Control+S' 
        };
        let currentKeybinds = { ...DEFAULT_KEYBINDS };

        const programs = [ 
            { id: 'parameter-extractor', name: 'Parameter Extractor', icon: '🛠️', description: "Extracts URL parameters from various Azure Function JSON payloads.", file: 'Tools/parameter_tool.html', keybindAction: 'paramExtractor' }, 
            { id: 'batch-count-calculator', name: 'Batch Count Calculator', icon: '🧮', description: "Calculate batch sizes. Opens options modal.", modal: batchCountModal, keybindAction: 'batchCalculator' }, 
            { id: 'csv-to-json-processor', name: 'CSV to JSON Processor', icon: '📄', description: "Filters CSV data and converts it to structured JSON.", file: 'Tools/data_validation_tool_themed.html', keybindAction: 'csvToJson'}, // New tool added
            { id: 'tool-4', name: 'Tool 4 (Future)', icon: '⚙️', description: "This tool isn't implemented yet.", file: '#', keybindAction: 'tool4'}, 
            { id: 'tool-5', name: 'Tool 5 (Future)', icon: '⚙️', description: "This tool isn't implemented yet.", file: '#', keybindAction: 'tool5'} 
        ];
        const renameIconSVG = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z'/></svg>`;
        const deleteIconSVG = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z'/></svg>`;

        function createProgramCard(item) { const isLink = item.file && item.file !== '#'; const card = document.createElement(isLink ? 'a' : 'div'); card.className = 'program-item'; card.id = `${item.id}-card`; let fullDesc = item.description; if (isLink) { card.href = item.file; card.target = '_blank'; card.rel = 'noopener noreferrer'; fullDesc = `Launches the ${item.name}. ${item.description}`; } else if (item.modal) { card.addEventListener('click', () => showModal(item.modal)); fullDesc = `Opens the ${item.name}. ${item.description}`; } else if (item.file === '#') { card.style.cursor = 'not-allowed'; card.addEventListener('click', (e) => { e.preventDefault(); showNotification(`"${item.name}" is not yet implemented.`, 3000, 'info'); }); } card.innerHTML = `<span class="item-icon">${item.icon || '⭐'}</span><span class="item-title">${item.name}</span>`; card.addEventListener('mouseover', () => { programExplanation.textContent = fullDesc; programExplanation.classList.add('active'); }); card.addEventListener('mouseout', () => { programExplanation.innerHTML = '<p>Hover over a program card above to see its explanation here.</p>'; programExplanation.classList.remove('active'); }); return card; }
        function populateMenus() { programMenu.innerHTML = ''; programs.forEach(prog => programMenu.appendChild(createProgramCard(prog)));}

        function hexToRgb(hex) { const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i; hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b); const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null; }
        
        // --- Background Visualizer Functions ---
        const boxBackgroundFunctions = { // Must use currentAppearanceSettings.backgroundVisualizer
            'theme_boxes': (i) => (i % 2 === 0) ? 'rgb(106, 13, 173)' : 'rgb(255, 165, 0)',
            'monochrome_boxes': () => { const gray = Math.floor(Math.random() * 55) + 200; return `rgb(${gray},${gray},${gray})`; },
            'solid_custom': () => currentAppearanceSettings.backgroundVisualizer.boxSolidColor1,
            'gradient_custom': () => `linear-gradient(${currentAppearanceSettings.backgroundVisualizer.boxGradientDirection}, ${currentAppearanceSettings.backgroundVisualizer.boxGradientColor1}, ${currentAppearanceSettings.backgroundVisualizer.boxGradientColor2})`
        };

        class Particle { 
            constructor(x, y, dX, dY, size, color) { this.x = x; this.y = y; this.dX = dX; this.dY = dY; this.size = size; this.color = color;}
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
            update() {
                const visSettings = currentAppearanceSettings.backgroundVisualizer;
                if (visSettings.wrapParticles) {
                    if (this.x > particleCanvas.width + this.size) this.x = -this.size; else if (this.x < -this.size) this.x = particleCanvas.width + this.size;
                    if (this.y > particleCanvas.height + this.size) this.y = -this.size; else if (this.y < -this.size) this.y = particleCanvas.height + this.size;
                } else {
                    if (this.x + this.size > particleCanvas.width || this.x - this.size < 0) this.dX *= -1;
                    if (this.y + this.size > particleCanvas.height || this.y - this.size < 0) this.dY *= -1;
                }
                if (visSettings.mouseRepelEnabled && mouseForParticles.x !== undefined && mouseForParticles.y !== undefined) {
                    let dx = mouseForParticles.x - this.x; let dy = mouseForParticles.y - this.y; let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < mouseForParticles.radius) { let fdx=dx/dist, fdy=dy/dist, force=(mouseForParticles.radius-dist)/mouseForParticles.radius; this.x -= fdx*force*5; this.y -= fdy*force*5; }
                }
                this.x += this.dX * visSettings.particleSpeedFactor; this.y += this.dY * visSettings.particleSpeedFactor; this.draw();
            }
        }
        function initParticles() {
            particlesArray = []; 
            const visSettings = currentAppearanceSettings.backgroundVisualizer;
            const palette = particleColorPalettes[visSettings.particleColorScheme] || particleColorPalettes.vibrant;
            for (let i = 0; i < visSettings.particleCount; i++) {
                let size = Math.random() * visSettings.maxParticleSize + 1;
                let x = Math.random() * (particleCanvas.width - size * 2) + size, y = Math.random() * (particleCanvas.height - size * 2) + size;
                let dX = (Math.random()*2-1), dY = (Math.random()*2-1), color = palette[Math.floor(Math.random()*palette.length)];
                particlesArray.push(new Particle(x, y, dX, dY, size, color));
            }
        }
        function connectParticles() {
            const visSettings = currentAppearanceSettings.backgroundVisualizer;
            if (!visSettings.showLines) return;
            const lineColorPalette = particleColorPalettes[visSettings.particleColorScheme] || particleColorPalettes.vibrant;
            const baseLineColorHex = lineColorPalette[0] || '#6A0DAD'; 
            const rgb = hexToRgb(baseLineColorHex);
            if (!rgb) return;
            const [r,g,b_val] = rgb; // Renamed b to b_val to avoid conflict with loop variable

            for (let a = 0; a < particlesArray.length; a++) {
                for (let b_loop = a + 1; b_loop < particlesArray.length; b_loop++) { // Renamed b to b_loop
                    let dx = particlesArray[a].x - particlesArray[b_loop].x;
                    let dy = particlesArray[a].y - particlesArray[b_loop].y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < visSettings.lineMaxDistance) {
                        let opacity = 1 - (dist / visSettings.lineMaxDistance);
                        ctx.strokeStyle = `rgba(${r},${g},${b_val}, ${opacity*0.5})`;
                        ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b_loop].x, particlesArray[b_loop].y); ctx.stroke();
                    }
                }
            }
        }
        function generateFloatingBoxes() {
            floatingBoxesList.innerHTML = ''; 
            const visSettings = currentAppearanceSettings.backgroundVisualizer;
            if (!visSettings.floatingBoxesEnabled) {
                floatingBoxesArea.style.display = 'none';
                return;
            }
            floatingBoxesArea.style.display = 'block';
            const baseDuration = 25;
            for (let i = 0; i < visSettings.boxCount; i++) {
                const li = document.createElement('li');
                const size = Math.random() * (visSettings.maxBoxSize - visSettings.minBoxSize) + visSettings.minBoxSize;
                Object.assign(li.style, {
                    width: `${size}px`, height: `${size}px`, left: `${Math.random() * 90}%`, opacity: visSettings.boxOpacity,
                    background: (boxBackgroundFunctions[visSettings.boxColorMode] || boxBackgroundFunctions['theme_boxes'])(i),
                    animationDuration: `${(Math.random() * 10 + (baseDuration - 5)) / visSettings.boxAnimationScale}s`,
                    animationDelay: `${Math.random() * baseDuration / visSettings.boxAnimationScale}s`,
                    boxShadow: visSettings.boxShadowsEnabled ? `3px 3px 10px rgba(0, 0, 0, ${visSettings.boxOpacity > 0.5 ? 0.2 : 0.15})` : 'none',
                    border: visSettings.boxBorderEnabled ? `${visSettings.boxBorderWidth}px solid ${visSettings.boxBorderColor}` : 'none'
                });
                floatingBoxesList.appendChild(li);
            }
        }
        function animateVisualizer() { 
            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update();
            connectParticles(); 
            animationFrameIdVisualizer = requestAnimationFrame(animateVisualizer);
        }
        function startOrRestartVisualizer() {
            if (animationFrameIdVisualizer) {
                cancelAnimationFrame(animationFrameIdVisualizer);
            }
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
            initParticles();
            generateFloatingBoxes(); // This also handles enabling/disabling the area
            animateVisualizer();
        }

        // --- Settings Management for Appearance & Visualizer ---
        function getControlValue(control) { // Helper for visualizer controls
            if (!control) return undefined;
            if (control.type === 'checkbox') return control.checked;
            if (control.type === 'range' || control.type === 'number') return parseFloat(control.value);
            return control.value;
        };

        function updateBackgroundVisualizerUIFromSettings() {
            const visSettings = currentAppearanceSettings.backgroundVisualizer;
            visControls.particleCountSlider.value = visSettings.particleCount; visControls.particleCountValue.textContent = visSettings.particleCount;
            visControls.particleSpeedSlider.value = visSettings.particleSpeedFactor; visControls.particleSpeedValue.textContent = visSettings.particleSpeedFactor.toFixed(1);
            visControls.particleSizeSlider.value = visSettings.maxParticleSize; visControls.particleSizeValue.textContent = visSettings.maxParticleSize.toFixed(1);
            visControls.particleColorSchemeSelect.value = visSettings.particleColorScheme;
            visControls.showLinesCheckbox.checked = visSettings.showLines;
            visControls.lineDistanceSlider.value = visSettings.lineMaxDistance; visControls.lineDistanceValue.textContent = visSettings.lineMaxDistance;
            visControls.wrapParticlesCheckbox.checked = visSettings.wrapParticles;
            visControls.mouseRepelCheckbox.checked = visSettings.mouseRepelEnabled;
            visControls.mouseRadiusSlider.value = visSettings.mouseRepelRadius; visControls.mouseRadiusValue.textContent = visSettings.mouseRepelRadius;
            
            visControls.toggleFloatingBoxesCheckbox.checked = visSettings.floatingBoxesEnabled;
            visControls.boxCountSlider.value = visSettings.boxCount; visControls.boxCountValue.textContent = visSettings.boxCount;
            visControls.maxBoxSizeSlider.value = visSettings.maxBoxSize; visControls.maxBoxSizeValue.textContent = visSettings.maxBoxSize;
            visControls.boxOpacitySlider.value = visSettings.boxOpacity; visControls.boxOpacityValue.textContent = visSettings.boxOpacity.toFixed(2);
            visControls.boxAnimationScaleSlider.value = visSettings.boxAnimationScale; visControls.boxAnimationScaleValue.textContent = visSettings.boxAnimationScale.toFixed(1);
            visControls.boxColorModeSelect.value = visSettings.boxColorMode;
            visControls.boxSolidColor1Input.value = visSettings.boxSolidColor1;
            visControls.boxGradientColor1Input.value = visSettings.boxGradientColor1;
            visControls.boxGradientColor2Input.value = visSettings.boxGradientColor2;
            visControls.boxGradientDirectionSelect.value = visSettings.boxGradientDirection;
            visControls.boxShadowsCheckbox.checked = visSettings.boxShadowsEnabled;
            visControls.boxBorderEnabledCheckbox.checked = visSettings.boxBorderEnabled;
            visControls.boxBorderWidthSlider.value = visSettings.boxBorderWidth; visControls.boxBorderWidthValue.textContent = visSettings.boxBorderWidth;
            visControls.boxBorderColorInput.value = visSettings.boxBorderColor;

            visControls.boxSolidColorControlsDiv.classList.toggle('visible', visSettings.boxColorMode === 'solid_custom');
            visControls.boxGradientControlsDiv.classList.toggle('visible', visSettings.boxColorMode === 'gradient_custom');
            visControls.boxBorderControlsDiv.classList.toggle('visible', visSettings.boxBorderEnabled);
        }

        function collectBackgroundVisualizerSettingsFromUI() {
            const visSettings = currentAppearanceSettings.backgroundVisualizer; // Modify in place
            visSettings.particleCount = getControlValue(visControls.particleCountSlider);
            visSettings.particleSpeedFactor = getControlValue(visControls.particleSpeedSlider);
            visSettings.maxParticleSize = getControlValue(visControls.particleSizeSlider);
            visSettings.particleColorScheme = getControlValue(visControls.particleColorSchemeSelect);
            visSettings.showLines = getControlValue(visControls.showLinesCheckbox);
            visSettings.lineMaxDistance = getControlValue(visControls.lineDistanceSlider);
            visSettings.wrapParticles = getControlValue(visControls.wrapParticlesCheckbox);
            visSettings.mouseRepelEnabled = getControlValue(visControls.mouseRepelCheckbox);
            visSettings.mouseRepelRadius = getControlValue(visControls.mouseRadiusSlider);
            
            visSettings.floatingBoxesEnabled = getControlValue(visControls.toggleFloatingBoxesCheckbox);
            visSettings.boxCount = getControlValue(visControls.boxCountSlider);
            visSettings.maxBoxSize = getControlValue(visControls.maxBoxSizeSlider);
            visSettings.boxOpacity = getControlValue(visControls.boxOpacitySlider);
            visSettings.boxAnimationScale = getControlValue(visControls.boxAnimationScaleSlider);
            visSettings.boxColorMode = getControlValue(visControls.boxColorModeSelect);
            visSettings.boxSolidColor1 = getControlValue(visControls.boxSolidColor1Input);
            visSettings.boxGradientColor1 = getControlValue(visControls.boxGradientColor1Input);
            visSettings.boxGradientColor2 = getControlValue(visControls.boxGradientColor2Input);
            visSettings.boxGradientDirection = getControlValue(visControls.boxGradientDirectionSelect);
            visSettings.boxShadowsEnabled = getControlValue(visControls.boxShadowsCheckbox);
            visSettings.boxBorderEnabled = getControlValue(visControls.boxBorderEnabledCheckbox);
            visSettings.boxBorderWidth = getControlValue(visControls.boxBorderWidthSlider);
            visSettings.boxBorderColor = getControlValue(visControls.boxBorderColorInput);
            
            mouseForParticles.radius = visSettings.mouseRepelRadius; // Update live mouse radius for particles
        }
        
        function applyAppearanceSettings(settings, source = "manual") { // Modified to accept settings and source
            const root = document.documentElement;
            root.style.setProperty('--header-gradient-start', settings.headerGradientStart);
            root.style.setProperty('--header-gradient-end', settings.headerGradientEnd);
            root.style.setProperty('--header-gradient-angle', `${settings.headerGradientAngle}deg`);
            // Page Background Image/Blur CSS variables removed

            if (settings.enableTranslucency) {
                document.body.classList.add('translucent-ui');
                const rgbArray = hexToRgb(settings.uiElementBaseColor);
                if (rgbArray) {
                    root.style.setProperty('--ui-element-base-color-rgb', rgbArray.join(', '));
                } else { 
                    const defaultRgbArray = hexToRgb(DEFAULT_APPEARANCE.uiElementBaseColor);
                    if (defaultRgbArray) root.style.setProperty('--ui-element-base-color-rgb', defaultRgbArray.join(', '));
                }
                root.style.setProperty('--ui-element-opacity', settings.uiElementOpacity.toString());
                root.style.setProperty('--ui-element-backdrop-blur', `${settings.uiElementBackdropBlur}px`);
            } else {
                document.body.classList.remove('translucent-ui');
            }
            
            // Apply background visualizer settings
            if (source === "manual" || source === "init" || source === "reset") {
                 // Update currentAppearanceSettings.backgroundVisualizer from UI if manual
                if (source === "manual") collectBackgroundVisualizerSettingsFromUI();
                // Then ensure UI display values and conditional visibility are correct
                updateBackgroundVisualizerUIFromSettings(); 
                startOrRestartVisualizer();
            } else if (source === "resize") {
                startOrRestartVisualizer(); // Just re-init with current settings for new dimensions
            }
        }

        function saveAppearanceSettingsToStorage(settings) { localStorage.setItem(APPEARANCE_STORAGE_KEY, JSON.stringify(settings)); }
        
        function loadAppearanceSettingsFromStorage() {
            const storedSettings = localStorage.getItem(APPEARANCE_STORAGE_KEY);
            if (storedSettings) {
                try {
                    const parsed = JSON.parse(storedSettings);
                    // Merge carefully to ensure new properties get defaults
                    currentAppearanceSettings = {
                        ...JSON.parse(JSON.stringify(DEFAULT_APPEARANCE)), // Start with deep copy of defaults
                        ...parsed, // Overlay stored top-level settings
                        backgroundVisualizer: { // Merge visualizer settings specifically
                            ...defaultBackgroundVisualizerSettings,
                            ...(parsed.backgroundVisualizer || {})
                        }
                    };
                } catch (e) {
                    console.error("Failed to parse appearance settings from storage, using defaults.", e);
                    currentAppearanceSettings = JSON.parse(JSON.stringify(DEFAULT_APPEARANCE));
                }
            } else {
                currentAppearanceSettings = JSON.parse(JSON.stringify(DEFAULT_APPEARANCE));
            }
            applyAppearanceSettings(currentAppearanceSettings, "init"); // Apply loaded or default settings
            updateAppearanceSettingsUI(currentAppearanceSettings); // Update all UI controls
        }

        function updateAppearanceSettingsUI(settings) { // Populates all settings modal UI
            headerGradientStartInput.value = settings.headerGradientStart; 
            headerGradientEndInput.value = settings.headerGradientEnd; 
            headerGradientAngleInput.value = settings.headerGradientAngle;
            // Page BG Image/Blur UI elements removed

            enableTranslucencyInput.checked = settings.enableTranslucency; 
            uiElementBaseColorInput.value = settings.uiElementBaseColor; 
            uiElementOpacityInput.value = settings.uiElementOpacity; 
            if(uiElementOpacityValueDisplay) uiElementOpacityValueDisplay.textContent = parseFloat(settings.uiElementOpacity).toFixed(2); 
            uiElementBackdropBlurInput.value = settings.uiElementBackdropBlur; 
            if(uiElementBackdropBlurValueDisplay) uiElementBackdropBlurValueDisplay.textContent = `${settings.uiElementBackdropBlur}px`;
            
            updateBackgroundVisualizerUIFromSettings(); // Update visualizer specific controls
        }

        function saveKeybindsToStorage(keybinds) { localStorage.setItem(KEYBINDS_STORAGE_KEY, JSON.stringify(keybinds)); }
        function loadKeybindsFromStorage() { 
            const storedKeybinds = localStorage.getItem(KEYBINDS_STORAGE_KEY); 
            try { 
                currentKeybinds = storedKeybinds ? { ...DEFAULT_KEYBINDS, ...JSON.parse(storedKeybinds) } : { ...DEFAULT_KEYBINDS };
            } catch (e) { 
                console.error("Failed to parse stored keybinds:", e); currentKeybinds = { ...DEFAULT_KEYBINDS }; 
            } 
            keybindParamExtractorInput.value = currentKeybinds.paramExtractor; 
            keybindBatchCalculatorInput.value = currentKeybinds.batchCalculator; 
            if (keybindCsvToJsonInput) keybindCsvToJsonInput.value = currentKeybinds.csvToJson; // Load new keybind
            keybindTool4Input.value = currentKeybinds.tool4; 
            keybindTool5Input.value = currentKeybinds.tool5; 
            keybindOpenSettingsInput.value = currentKeybinds.openSettings; 
            keybindPrevMonthInput.value = currentKeybinds.prevMonth; 
            keybindNextMonthInput.value = currentKeybinds.nextMonth; 
            keybindGotoTodayInput.value = currentKeybinds.gotoToday; 
            keybindNewNoteInput.value = currentKeybinds.newNote; 
            keybindDeleteAllNotesInput.value = currentKeybinds.deleteAllNotes; 
            keybindSaveNoteInput.value = currentKeybinds.saveNote; 
        }
        function loadNotes() { const storedNotes = localStorage.getItem(NOTES_STORAGE_KEY); if (storedNotes) { try { notesData = JSON.parse(storedNotes); } catch (e) { console.error("Failed to parse notes from localStorage:", e); notesData = {}; }} else { notesData = {}; } }
        function saveNotes() { try { localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notesData)); } catch (e) { console.error("Failed to save notes to localStorage:", e); showNotification("Error saving notes. Storage might be full.", 5000, 'error');}}
        function renderCalendar(month, year) { calendarDaysGrid.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1); const daysInMonth = new Date(year, month + 1, 0).getDate(); const lastDayOfPrevMonth = new Date(year, month, 0).getDate(); const startingDayOfWeek = firstDayOfMonth.getDay(); currentMonthYearDisplay.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' }); const today = new Date(); const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; for (let i = startingDayOfWeek; i > 0; i--) { const dayElement = document.createElement('div'); dayElement.classList.add('calendar-day', 'inactive'); dayElement.textContent = lastDayOfPrevMonth - i + 1; calendarDaysGrid.appendChild(dayElement); } for (let i = 1; i <= daysInMonth; i++) { const dayElement = document.createElement('div'); dayElement.classList.add('calendar-day'); dayElement.textContent = i; const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`; dayElement.dataset.date = dateString; if (dateString === todayString) dayElement.classList.add('today'); if (notesData[dateString] && notesData[dateString].length > 0) { const noteIndicator = document.createElement('div'); noteIndicator.classList.add('note-indicator'); dayElement.appendChild(noteIndicator); } dayElement.addEventListener('click', handleDayClick); calendarDaysGrid.appendChild(dayElement); } const totalDaysRendered = calendarDaysGrid.children.length; const remainingCells = (totalDaysRendered % 7 === 0) ? 0 : 7 - (totalDaysRendered % 7); for (let i = 1; i <= remainingCells; i++) { const dayElement = document.createElement('div'); dayElement.classList.add('calendar-day', 'inactive'); dayElement.textContent = i; calendarDaysGrid.appendChild(dayElement); } }
        function handleDayClick(event) { const clickedDay = event.target.closest('.calendar-day'); if (!clickedDay || clickedDay.classList.contains('inactive')) return; const previouslySelectedDay = calendarDaysGrid.querySelector('.calendar-day.selected'); if (previouslySelectedDay) previouslySelectedDay.classList.remove('selected'); clickedDay.classList.add('selected'); selectedDate = clickedDay.dataset.date; const dateObj = new Date(selectedDate + 'T00:00:00'); notesHeading.textContent = `Notes for ${dateObj.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; createNoteBtn.style.display = 'inline-block'; const notesExistForDay = notesData[selectedDate] && notesData[selectedDate].length > 0; deleteAllNotesBtn.style.display = notesExistForDay ? 'inline-block' : 'none'; saveAllNotesBtn.style.display = 'none'; displayNotesForSelectedDay(); }
        function displayNotesForSelectedDay() { notesList.innerHTML = ''; const placeholderNoDaySelected = `<li style="text-align:center;color:#777;font-style:italic;padding:10px 0;">Select a day to see or add notes.</li>`; const placeholderNoNotes = `<li style="text-align:center;color:#777;font-style:italic;padding:10px 0;">No notes for this day. Click "+ New Note" to add one.</li>`; if (!selectedDate) { notesList.innerHTML = placeholderNoDaySelected; createNoteBtn.style.display = 'none'; deleteAllNotesBtn.style.display = 'none'; saveAllNotesBtn.style.display = 'none'; return; } const notesForDay = notesData[selectedDate] || []; if (notesForDay.length === 0) { notesList.innerHTML = placeholderNoNotes; deleteAllNotesBtn.style.display = 'none'; saveAllNotesBtn.style.display = 'none'; } else { notesForDay.forEach((note, index) => { const listItem = document.createElement('li'); listItem.classList.add('note-item'); listItem.dataset.index = index; const noteNameSpan = document.createElement('span'); noteNameSpan.className = 'note-name'; noteNameSpan.title = note.name; noteNameSpan.textContent = note.name; listItem.appendChild(noteNameSpan); const actionsDiv = document.createElement('div'); actionsDiv.className = 'note-actions'; actionsDiv.innerHTML = `<button class="note-action-button rename-button" aria-label="Rename Note" title="Rename">${renameIconSVG}<span class="tooltip">Rename</span></button><button class="note-action-button delete-button" aria-label="Delete Note" title="Delete">${deleteIconSVG}<span class="tooltip">Delete</span></button>`; listItem.appendChild(actionsDiv); listItem.querySelector('.rename-button').addEventListener('click', (e) => { e.stopPropagation(); renameNote(selectedDate, index); }); listItem.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); deleteNote(selectedDate, index); }); listItem.addEventListener('click', () => openNoteEditor(selectedDate, index)); notesList.appendChild(listItem); }); deleteAllNotesBtn.style.display = 'inline-block'; saveAllNotesBtn.style.display = 'none'; } }
        function escapeHTML(str) { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
        function showModal(modalElement) { if (modalElement) modalElement.classList.add('visible'); }
        function hideModal(modalElement) { if (modalElement) modalElement.classList.remove('visible'); }
        createNoteBtn.addEventListener('click', () => { if (selectedDate) { showModal(nameNoteModal); noteNameInput.value = ''; noteNameInput.focus(); } else { showNotification("Please select a day first to create a note.", 3000, 'error'); }});
        deleteAllNotesBtn.addEventListener('click', () => { if (!selectedDate || !notesData[selectedDate] || notesData[selectedDate].length === 0) { showNotification("No notes to delete for the selected day.", 3000, 'error'); return; } const dateObj = new Date(selectedDate + 'T00:00:00'); if (confirm(`Are you sure you want to delete all notes for ${dateObj.toLocaleDateString()}?`)) { delete notesData[selectedDate]; saveNotes(); const dayElementWithIndicator = calendarDaysGrid.querySelector(`.calendar-day[data-date="${selectedDate}"] .note-indicator`); if (dayElementWithIndicator) dayElementWithIndicator.remove(); displayNotesForSelectedDay(); showNotification(`All notes for ${dateObj.toLocaleDateString()} have been deleted.`, 3000); } });
        saveAllNotesBtn.addEventListener('click', () => { if (!selectedDate || !notesData[selectedDate] || notesData[selectedDate].length === 0) { showNotification("No notes to save for the selected day.", 3000, 'error'); return; } const notesToSave = notesData[selectedDate]; showNotification(`Saving ${notesToSave.length} note(s)...`, 2000); notesToSave.forEach(note => { const blob = new Blob([note.content], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const safeFilename = (note.name || 'untitled_note').replace(/[^\w\s.-]/gi, '_'); link.download = `${safeFilename}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }); showNotification("All notes for the selected day have been downloaded as individual files!", 3000); });
        function renameNote(dateString, noteIndex) { const note = notesData[dateString]?.[noteIndex]; if (!note) { showNotification("Error: Could not find the note to rename.", 3000, 'error'); return; } const newName = prompt(`Rename note "${note.name}" to:`, note.name); if (newName === null || newName.trim() === "" || newName.trim() === note.name) return; const trimmedNewName = newName.trim(); if (notesData[dateString].some((nt, idx) => idx !== noteIndex && nt.name === trimmedNewName)) { showNotification(`A note with the name "${trimmedNewName}" already exists for this day.`, 4000, 'error'); return; } notesData[dateString][noteIndex].name = trimmedNewName; saveNotes(); displayNotesForSelectedDay(); showNotification(`Note renamed to "${trimmedNewName}".`, 3000); }
        function deleteNote(dateString, noteIndex) { const note = notesData[dateString]?.[noteIndex]; if (!note) { showNotification("Error: Could not find the note to delete.", 3000, 'error'); return; } if (confirm(`Are you sure you want to delete the note "${note.name}"?`)) { notesData[dateString].splice(noteIndex, 1); if (notesData[dateString].length === 0) { delete notesData[dateString]; const dayElementWithIndicator = calendarDaysGrid.querySelector(`.calendar-day[data-date="${dateString}"] .note-indicator`); if (dayElementWithIndicator) dayElementWithIndicator.remove(); } saveNotes(); displayNotesForSelectedDay(); showNotification(`Note "${note.name}" deleted.`, 3000); } }
        saveNoteNameBtn.addEventListener('click', () => { const noteName = noteNameInput.value.trim(); if (!selectedDate) { showNotification("No day selected. Cannot create note.", 3000, 'error'); hideModal(nameNoteModal); return; } if (!noteName) { showNotification("Note name cannot be empty.", 3000, 'error'); noteNameInput.focus(); return; } if (!notesData[selectedDate]) notesData[selectedDate] = []; if (notesData[selectedDate].some(note => note.name === noteName)) { showNotification(`A note with the name "${noteName}" already exists for this day.`, 4000, 'error'); noteNameInput.focus(); return; } const newNote = { name: noteName, content: '' }; notesData[selectedDate].push(newNote); saveNotes(); displayNotesForSelectedDay(); const dayElement = calendarDaysGrid.querySelector(`.calendar-day[data-date="${selectedDate}"]`); if (dayElement && !dayElement.querySelector('.note-indicator')) { const indicator = document.createElement('div'); indicator.classList.add('note-indicator'); dayElement.appendChild(indicator); } hideModal(nameNoteModal); openNoteEditor(selectedDate, notesData[selectedDate].length - 1); });
        cancelNoteNameBtn.addEventListener('click', () => { hideModal(nameNoteModal); noteNameInput.value = ''; });
        function openNoteEditor(dateString, noteIndex) { const note = notesData[dateString]?.[noteIndex]; if (!note) { showNotification("Error loading note.", 3000, 'error'); return; } editorNoteTitle.textContent = `Editing: ${escapeHTML(note.name)}`; noteEditorTextarea.value = note.content; saveNoteContentBtn.dataset.date = dateString; saveNoteContentBtn.dataset.index = noteIndex; showModal(editorModal); noteEditorTextarea.focus(); }
        saveNoteContentBtn.addEventListener('click', () => { const dateString = saveNoteContentBtn.dataset.date; const noteIndex = parseInt(saveNoteContentBtn.dataset.index); const newContent = noteEditorTextarea.value; if (dateString && !isNaN(noteIndex) && notesData[dateString]?.[noteIndex]) { notesData[dateString][noteIndex].content = newContent; saveNotes(); showNotification("Note saved!"); } else { showNotification("Error saving note.", 3000, 'error'); } });
        copyEditorContentBtn.addEventListener('click', () => { const textToCopy = noteEditorTextarea.value; if (!textToCopy.trim()) { showNotification("Nothing to copy.", 2000); return; } navigator.clipboard.writeText(textToCopy).then(() => { showNotification("Content copied!"); }).catch(err => { console.error('Clipboard copy failed:', err); showNotification("Failed to copy.", 3000, 'error'); }); });
        closeEditorBtn.addEventListener('click', () => { hideModal(editorModal); noteEditorTextarea.value = ''; saveNoteContentBtn.dataset.date = ''; saveNoteContentBtn.dataset.index = ''; });
        batchCountHighestBtn.addEventListener('click', () => { window.open('Tools/Batchcountcalculator/batchcount_calculator-highestround.html', '_blank', 'noopener,noreferrer'); hideModal(batchCountModal); });
        batchCountNearestBtn.addEventListener('click', () => { window.open('Tools/Batchcountcalculator/batchcount_calculator-nearestround.html', '_blank', 'noopener,noreferrer'); hideModal(batchCountModal); });
        cancelBatchCountBtn.addEventListener('click', () => hideModal(batchCountModal));
        
        settingsButton.addEventListener('click', () => { 
            // Load appearance settings which now includes visualizer, then update all UI
            loadAppearanceSettingsFromStorage(); // This will call updateAppearanceSettingsUI
            loadKeybindsFromStorage(); 
            showModal(settingsModal); 
        });
        closeSettingsBtn.addEventListener('click', () => hideModal(settingsModal));
        
        applyAppearanceBtn.addEventListener('click', () => { 
            currentAppearanceSettings.headerGradientStart = headerGradientStartInput.value; 
            currentAppearanceSettings.headerGradientEnd = headerGradientEndInput.value; 
            currentAppearanceSettings.headerGradientAngle = parseInt(headerGradientAngleInput.value, 10) || DEFAULT_APPEARANCE.headerGradientAngle; 
            
            currentAppearanceSettings.enableTranslucency = enableTranslucencyInput.checked; 
            currentAppearanceSettings.uiElementBaseColor = uiElementBaseColorInput.value; 
            currentAppearanceSettings.uiElementOpacity = parseFloat(uiElementOpacityInput.value); 
            currentAppearanceSettings.uiElementBackdropBlur = parseInt(uiElementBackdropBlurInput.value, 10); 
            
            // Collect visualizer settings from UI into currentAppearanceSettings.backgroundVisualizer
            collectBackgroundVisualizerSettingsFromUI();
            // Apply all settings (header, translucency, and visualizer)
            applyAppearanceSettings(currentAppearanceSettings, "manual"); 
            saveAppearanceSettingsToStorage(currentAppearanceSettings); 
            showNotification("All appearance settings applied!"); 
        });
        resetAppearanceBtn.addEventListener('click', () => { 
            currentAppearanceSettings = JSON.parse(JSON.stringify(DEFAULT_APPEARANCE)); // Deep copy defaults
            applyAppearanceSettings(currentAppearanceSettings, "reset"); 
            saveAppearanceSettingsToStorage(currentAppearanceSettings); 
            updateAppearanceSettingsUI(currentAppearanceSettings); // Ensure UI reflects reset state
            showNotification("All appearance settings reset to default."); 
        });

        // Event listeners for individual visualizer controls to update UI and live preview
        Object.values(visControls).forEach(control => {
            if (control instanceof HTMLElement && (control.tagName === 'INPUT' || control.tagName === 'SELECT') && 
                control.id !== 'resetParticleSettingsBtn' && control.id !== 'resetBoxSettingsBtn') { // Exclude buttons
                const eventType = (['range', 'color'].includes(control.type)) ? 'input' : 'change';
                control.addEventListener(eventType, () => {
                    collectBackgroundVisualizerSettingsFromUI(); // Update current settings from this control
                    applyAppearanceSettings(currentAppearanceSettings, "manual"); // Re-apply visualizer part
                    // No save to storage here, only on "Apply All Appearance"
                    // But update the UI value displays if they exist
                    updateBackgroundVisualizerUIFromSettings(); 
                });
            }
        });
        visControls.resetParticleSettingsBtn.addEventListener('click', () => {
            const particleKeys = Object.keys(defaultBackgroundVisualizerSettings).filter(k => k.toLowerCase().includes('particle') || k.toLowerCase().includes('mouse'));
            particleKeys.forEach(key => {
                currentAppearanceSettings.backgroundVisualizer[key] = defaultBackgroundVisualizerSettings[key];
            });
            applyAppearanceSettings(currentAppearanceSettings, "reset");
            updateBackgroundVisualizerUIFromSettings();
            showNotification("Particle visualizer settings reset to default.");
        });
        visControls.resetBoxSettingsBtn.addEventListener('click', () => {
            const boxKeys = Object.keys(defaultBackgroundVisualizerSettings).filter(k => k.toLowerCase().includes('box'));
             boxKeys.forEach(key => {
                currentAppearanceSettings.backgroundVisualizer[key] = defaultBackgroundVisualizerSettings[key];
            });
            applyAppearanceSettings(currentAppearanceSettings, "reset");
            updateBackgroundVisualizerUIFromSettings();
            showNotification("Floating box visualizer settings reset to default.");
        });


        [uiElementOpacityInput, uiElementBackdropBlurInput].forEach(slider => { 
            if (slider) { 
                const displayId = slider.id.replace('-input', '-value'); 
                const displayElement = document.getElementById(displayId); 
                if (displayElement) { 
                    slider.addEventListener('input', () => { 
                        let value = slider.value; 
                        if (slider.id === 'ui-element-opacity-input') value = parseFloat(value).toFixed(2); 
                        else value = `${value}px`; displayElement.textContent = value; 
                    }); 
                } 
            } 
        });
        // Range slider value displays for visualizer (already handled by updateBackgroundVisualizerUIFromSettings on input/change)

        saveKeybindsBtn.addEventListener('click', () => { 
            currentKeybinds.paramExtractor = keybindParamExtractorInput.value.trim(); 
            currentKeybinds.batchCalculator = keybindBatchCalculatorInput.value.trim(); 
            if (keybindCsvToJsonInput) currentKeybinds.csvToJson = keybindCsvToJsonInput.value.trim(); // Save new keybind
            currentKeybinds.tool4 = keybindTool4Input.value.trim(); 
            currentKeybinds.tool5 = keybindTool5Input.value.trim(); 
            currentKeybinds.openSettings = keybindOpenSettingsInput.value.trim(); 
            currentKeybinds.prevMonth = keybindPrevMonthInput.value.trim(); 
            currentKeybinds.nextMonth = keybindNextMonthInput.value.trim(); 
            currentKeybinds.gotoToday = keybindGotoTodayInput.value.trim(); 
            currentKeybinds.newNote = keybindNewNoteInput.value.trim(); 
            currentKeybinds.deleteAllNotes = keybindDeleteAllNotesInput.value.trim(); 
            currentKeybinds.saveNote = keybindSaveNoteInput.value.trim(); 
            saveKeybindsToStorage(currentKeybinds); 
            showNotification("Keybinds saved!"); 
        });
        resetKeybindsBtn.addEventListener('click', () => { currentKeybinds = { ...DEFAULT_KEYBINDS }; saveKeybindsToStorage(currentKeybinds); loadKeybindsFromStorage(); showNotification("Keybinds reset to default."); });
        function exportNotesData() { if (Object.keys(notesData).length === 0) { showNotification("No notes data to export.", 3000, 'info'); return; } try { const jsonData = JSON.stringify(notesData, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-'); a.download = `ado-insights-notes-backup-${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showNotification("All notes data exported successfully!", 3000); } catch (error) { console.error("Error exporting notes data:", error); showNotification("Failed to export notes data. See console for details.", 4000, 'error'); } }
        if (exportNotesBtn) exportNotesBtn.addEventListener('click', exportNotesData);
        function processImportFile(file) { if (!file) { showNotification("No file selected for import.", 3000, 'error'); return; } if (file.type !== 'application/json') { showNotification("Invalid file type. Please select a JSON file (.json).", 4000, 'error'); return; } const reader = new FileReader(); reader.onload = (event) => { try { const importedRawData = event.target.result; const importedParsedData = JSON.parse(importedRawData); if (typeof importedParsedData !== 'object' || importedParsedData === null) { throw new Error("Imported data is not a valid JSON object."); } for (const dateKey in importedParsedData) { if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) { throw new Error(`Invalid date key format in imported data: ${dateKey}`); } if (!Array.isArray(importedParsedData[dateKey])) { throw new Error(`Data for date ${dateKey} is not an array.`); } importedParsedData[dateKey].forEach(note => { if (typeof note !== 'object' || note === null || typeof note.name !== 'string' || typeof note.content !== 'string') { throw new Error(`Invalid note structure for date ${dateKey}. Each note must have 'name' and 'content' strings.`); } }); } if (!confirm("Importing will overwrite all current notes. Are you sure you want to proceed?")) { showNotification("Import cancelled by user.", 3000, 'info'); return; } notesData = importedParsedData; saveNotes(); renderCalendar(currentMonth, currentYear); if (selectedDate && notesData[selectedDate]) { displayNotesForSelectedDay(); } else if (selectedDate) { selectedDate = null; notesHeading.textContent = `Notepad`; displayNotesForSelectedDay(); } else { notesHeading.textContent = `Notepad`; displayNotesForSelectedDay(); } showNotification("Notes data imported successfully! The page will now refresh to apply all changes.", 4000); setTimeout(() => window.location.reload(), 4100); } catch (error) { console.error("Error processing imported file:", error); showNotification(`Import failed: ${error.message}`, 5000, 'error'); } finally { importNotesFileInput.value = ''; } }; reader.onerror = () => { showNotification("Error reading the import file.", 4000, 'error'); importNotesFileInput.value = ''; }; reader.readAsText(file); }
        if (importDropZone) { importDropZone.addEventListener('click', () => importNotesFileInput.click()); importDropZone.addEventListener('dragover', (event) => { event.preventDefault(); importDropZone.classList.add('dragover'); }); importDropZone.addEventListener('dragleave', () => { importDropZone.classList.remove('dragover'); }); importDropZone.addEventListener('drop', (event) => { event.preventDefault(); importDropZone.classList.remove('dragover'); if (event.dataTransfer.files && event.dataTransfer.files[0]) { processImportFile(event.dataTransfer.files[0]); } }); importDropZone.addEventListener('keydown', (event) => { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); importNotesFileInput.click(); } }); }
        if (importNotesFileInput) { importNotesFileInput.addEventListener('change', (event) => { if (event.target.files && event.target.files[0]) { processImportFile(event.target.files[0]); } }); }
        [nameNoteModal, editorModal, batchCountModal, settingsModal].forEach(modal => { if (modal) { modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(modal); });}});
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (nameNoteModal && nameNoteModal.classList.contains('visible')) hideModal(nameNoteModal); else if (editorModal && editorModal.classList.contains('visible')) hideModal(editorModal); else if (batchCountModal && batchCountModal.classList.contains('visible')) hideModal(batchCountModal); else if (settingsModal && settingsModal.classList.contains('visible')) hideModal(settingsModal); }});
        document.addEventListener('keydown', (event) => { 
            const activeElement = document.activeElement; 
            const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.isContentEditable); 
            if (isTyping) { 
                if (settingsModal && settingsModal.classList.contains('visible') && activeElement.closest('#settings-modal')) { 
                    if (event.key === "Escape") {} else { return; } 
                } else if (!settingsModal || !settingsModal.classList.contains('visible')) { 
                    return; 
                } 
            } 
            let keyString = ""; 
            if (event.ctrlKey) keyString += "Control+"; 
            if (event.altKey) keyString += "Alt+"; 
            if (event.shiftKey) keyString += "Shift+"; 
            const keyName = event.key.length === 1 ? event.key.toUpperCase() : event.key; 
            keyString += keyName; 
            const clickToolCard = (toolId) => { const card = document.getElementById(`${toolId}-card`); if (card) card.click(); }; 
            
            if (currentKeybinds.paramExtractor && keyString === currentKeybinds.paramExtractor.toUpperCase()) { event.preventDefault(); clickToolCard('parameter-extractor'); } 
            else if (currentKeybinds.batchCalculator && keyString === currentKeybinds.batchCalculator.toUpperCase()) { event.preventDefault(); clickToolCard('batch-count-calculator'); } 
            else if (currentKeybinds.csvToJson && keyString === currentKeybinds.csvToJson.toUpperCase()) { event.preventDefault(); clickToolCard('csv-to-json-processor'); } // Handle new tool
            else if (currentKeybinds.tool4 && keyString === currentKeybinds.tool4.toUpperCase()) { event.preventDefault(); clickToolCard('tool-4'); } 
            else if (currentKeybinds.tool5 && keyString === currentKeybinds.tool5.toUpperCase()) { event.preventDefault(); clickToolCard('tool-5'); } 
            else if (currentKeybinds.openSettings && keyString === currentKeybinds.openSettings.toUpperCase()) { event.preventDefault(); if (settingsModal && settingsModal.classList.contains('visible')) hideModal(settingsModal); else if (settingsButton) settingsButton.click(); } 
            else if (currentKeybinds.prevMonth && keyString === currentKeybinds.prevMonth) { if (!isTyping || (settingsModal && settingsModal.classList.contains('visible'))) { event.preventDefault(); if(prevMonthBtn) prevMonthBtn.click(); }}  
            else if (currentKeybinds.nextMonth && keyString === currentKeybinds.nextMonth) { if (!isTyping || (settingsModal && settingsModal.classList.contains('visible'))) { event.preventDefault(); if(nextMonthBtn) nextMonthBtn.click(); }}  
            else if (currentKeybinds.gotoToday && keyString === currentKeybinds.gotoToday.toUpperCase()) { if (!isTyping || (settingsModal && settingsModal.classList.contains('visible'))) { event.preventDefault(); const todayElem = calendarDaysGrid.querySelector('.calendar-day.today'); if (todayElem) todayElem.click(); else { currentMonth = new Date().getMonth(); currentYear = new Date().getFullYear(); renderCalendar(currentMonth, currentYear); setTimeout(() => { const todayElemAfterRender = calendarDaysGrid.querySelector('.calendar-day.today'); if(todayElemAfterRender) todayElemAfterRender.click(); }, 0); } } } 
            else if (currentKeybinds.newNote && keyString === currentKeybinds.newNote.toUpperCase()) { const noModalOpen = (!nameNoteModal || !nameNoteModal.classList.contains('visible')) && (!editorModal || !editorModal.classList.contains('visible')) && (!settingsModal || !settingsModal.classList.contains('visible')) && (!batchCountModal || !batchCountModal.classList.contains('visible')); if (selectedDate && noModalOpen && createNoteBtn) { event.preventDefault(); createNoteBtn.click(); }}  
            else if (currentKeybinds.deleteAllNotes && keyString === currentKeybinds.deleteAllNotes.toUpperCase()) { const noModalOpen = (!nameNoteModal || !nameNoteModal.classList.contains('visible')) && (!editorModal || !editorModal.classList.contains('visible')) && (!settingsModal || !settingsModal.classList.contains('visible')) && (!batchCountModal || !batchCountModal.classList.contains('visible')); if (selectedDate && notesData[selectedDate] && notesData[selectedDate].length > 0 && noModalOpen && deleteAllNotesBtn) { event.preventDefault(); deleteAllNotesBtn.click(); }} 
            else if (currentKeybinds.saveNote && keyString === currentKeybinds.saveNote.toUpperCase()) { if (editorModal && editorModal.classList.contains('visible') && saveNoteContentBtn) { event.preventDefault(); saveNoteContentBtn.click(); }} 
        });
        function showNotification(message, duration = 3000, type = 'info') { const container = document.getElementById('notification-container'); if (!container) { console.warn("Notification container not found."); return; } const notification = document.createElement('div'); notification.className = 'notification'; if (type === 'error') notification.classList.add('error'); notification.textContent = message; container.appendChild(notification); setTimeout(() => { notification.classList.add('fade-out'); notification.addEventListener('animationend', () => notification.remove(), { once: true }); }, duration - NOTIFICATION_FADE_DURATION); }
        
        window.addEventListener('mousemove', e => { mouseForParticles.x = e.clientX; mouseForParticles.y = e.clientY; });
        window.addEventListener('mouseout', () => { mouseForParticles.x = undefined; mouseForParticles.y = undefined; });
        window.addEventListener('resize', () => {
            applyAppearanceSettings(currentAppearanceSettings, "resize"); // This will re-init visualizer
        });
        
        document.addEventListener('DOMContentLoaded', () => { 
            loadAppearanceSettingsFromStorage(); // This now loads, applies, and updates UI for all appearance including visualizer
            loadNotes(); 
            loadKeybindsFromStorage(); 
            populateMenus(); 
            renderCalendar(currentMonth, currentYear); 
            displayNotesForSelectedDay(); 
            // Visualizer is started by loadAppearanceSettingsFromStorage calling applyAppearanceSettings with "init"
        });
        if (prevMonthBtn) { prevMonthBtn.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } selectedDate = null; notesHeading.textContent = `Notepad`; createNoteBtn.style.display = 'none'; deleteAllNotesBtn.style.display = 'none'; saveAllNotesBtn.style.display = 'none'; displayNotesForSelectedDay(); renderCalendar(currentMonth, currentYear); });}
        if (nextMonthBtn) { nextMonthBtn.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } selectedDate = null; notesHeading.textContent = `Notepad`; createNoteBtn.style.display = 'none'; deleteAllNotesBtn.style.display = 'none'; saveAllNotesBtn.style.display = 'none'; displayNotesForSelectedDay(); renderCalendar(currentMonth, currentYear); });}

        // Initialize min/max for visualizer sliders
        visControls.particleCountSlider.min=10; visControls.particleCountSlider.max=500;
        visControls.particleSpeedSlider.min=0.1; visControls.particleSpeedSlider.max=3; visControls.particleSpeedSlider.step=0.1;
        visControls.particleSizeSlider.min=1; visControls.particleSizeSlider.max=10; visControls.particleSizeSlider.step=0.5;
        visControls.lineDistanceSlider.min=20; visControls.lineDistanceSlider.max=300;
        visControls.mouseRadiusSlider.min=20; visControls.mouseRadiusSlider.max=200;
        visControls.boxCountSlider.min=5; visControls.boxCountSlider.max=50;
        visControls.maxBoxSizeSlider.min=20; visControls.maxBoxSizeSlider.max=200;
        visControls.boxOpacitySlider.min=0.05; visControls.boxOpacitySlider.max=1; visControls.boxOpacitySlider.step=0.05;
        visControls.boxAnimationScaleSlider.min=0.5; visControls.boxAnimationScaleSlider.max=3; visControls.boxAnimationScaleSlider.step=0.1;
        visControls.boxBorderWidthSlider.min=1; visControls.boxBorderWidthSlider.max=10;

    </script>
</body>
</html>
