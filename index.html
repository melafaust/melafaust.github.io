<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps Insights Tool</title>
    <link href="https://fonts.googleapis.com/css?family=Exo:400,700" rel="stylesheet">
    <style>
        /* CSS Root Variables: Defines the color palette and sizing for the application. */
        :root {
            /* Default (Light) Theme Colors */
            --header-gradient-start: #4A0082;
            --header-gradient-end: #D4529D;
            --header-gradient-angle: 105deg; 
            --header-main-title-color: #FFFFFF;
            --page-bg-color: #F8F9FA;
            --section-title-color: var(--header-gradient-start);
            --card-bg-color: #FFFFFF; 
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-border-radius: 8px;
            --card-title-color: var(--header-gradient-start);
            --card-icon-color: #8A3DAF;
            --text-color-dark: #333333;
            --link-color: var(--header-gradient-start);
            --button-primary-bg: var(--header-gradient-start);
            --button-primary-text-color: #FFFFFF;
            --button-primary-hover-bg: #3A006A;
            --input-bg: #ffffff;
            --input-border-color: #ced4da;
            --input-text-color: #495057;
            --danger-color: #dc3545;
            --toggle-icon-fill: #FFFFFF;
        }

        body.dark-mode {
            --header-gradient-start: #23272A;
            --header-gradient-end: #5865F2;
            --page-bg-color: #2C2F33;
            --section-title-color: #FFFFFF;
            --card-bg-color: #23272A;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --card-title-color: #FFFFFF;
            --card-icon-color: #7289DA;
            --text-color-dark: #E1E1E1;
            --link-color: #7289DA;
            --button-primary-bg: #5865F2;
            --button-primary-hover-bg: #4752C4;
            --input-bg: #40444B;
            --input-border-color: #2C2F33;
            --input-text-color: #FFFFFF;
            --danger-color: #ED4245;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--page-bg-color); 
            color: var(--text-color-dark);
            margin: 0; padding: 0; line-height: 1.65; overflow-x: hidden;
            box-sizing: border-box; position: relative; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        *, *:before, *:after { box-sizing: inherit; }

        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        .area { width: 100%; height: 100vh; position: fixed; top: 0; left: 0; z-index: -1; display: none; }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .circles li { position: absolute; display: block; list-style: none; bottom: -200px; animation-name: animateBoxVisualizer; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes animateBoxVisualizer { 0% { transform: translateY(0) rotate(0deg); border-radius: 0; } 100% { transform: translateY(-1200px) rotate(720deg); opacity: 0 !important; border-radius: 50%; } }

        .top-header-wrapper {
            background: linear-gradient(var(--header-gradient-angle), var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-main-title-color); padding: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); position: relative;
            z-index: 2;
            transition: background 0.3s ease;
        }
        .top-header-content { width: 95%; max-width: 1100px; margin: 0 auto; text-align: center; display: flex; justify-content: center; align-items: center; position: relative; }
        .top-header-content h1 { font-size: 2rem; font-weight: 700; margin: 0; color: var(--header-main-title-color); flex-grow: 1; }
        
        #dark-mode-toggle {
            background: none;
            border: none;
            color: var(--toggle-icon-fill);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: transform 0.3s ease-in-out, background-color 0.2s ease;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        #dark-mode-toggle svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            transition: transform 0.4s ease;
        }
        #dark-mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .sun-icon { display: none; }
        .dark-mode .sun-icon { display: block; }
        .dark-mode .moon-icon { display: none; }


        .container { width: 95%; max-width: 1100px; margin: 30px auto; padding: 0 15px; position: relative; z-index: 1; }
        .tools-title { font-size: 2rem; font-weight: 700; color: var(--section-title-color); margin-bottom: 30px; text-align: left; }
        .content-section { margin-bottom: 40px; }
        #programs-section > h2 { display: none; }
        #program-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 20px; margin-bottom: 20px; }

        .program-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px 15px; background-color: var(--card-bg-color); border: 1px solid #E9ECEF; border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, border-color 0.3s ease; text-decoration: none; min-height: 140px; }
        .dark-mode .program-item { border-color: #40444B; }
        .program-item:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); }
        .program-item .item-icon { font-size: 2.4rem; color: var(--card-icon-color); margin-bottom: 15px; }
        .program-item .item-title { font-size: 1rem; font-weight: 700; color: var(--card-title-color); margin: 0; line-height: 1.35; }
        
        #program-explanation { padding: 20px; background-color: var(--card-bg-color); border: 1px solid #E9ECEF; border-radius: var(--card-border-radius); min-height: 70px; white-space: pre-wrap; font-style: italic; color: #555; box-shadow: var(--card-shadow); font-size: 0.95rem; margin-top: 20px; margin-bottom: 40px; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .dark-mode #program-explanation { border-color: #40444B; color: #B9BBBE; }
        #program-explanation.active { font-style: normal; color: var(--text-color-dark); }
        .dark-mode #program-explanation.active { color: #FFFFFF; }


        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; } 
        .modal-content { background-color: var(--card-bg-color); padding: 30px; border-radius: var(--card-border-radius); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); max-width: 600px; width: 90%; transform: translateY(-20px); transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; color: var(--text-color-dark); max-height: 85vh; overflow-y: auto; }
        .dark-mode .modal-content { border-color: #40444B; }
        .modal-overlay.visible .modal-content { transform: translateY(0); } 
        .modal-content h3 { margin-top: 0; color: var(--section-title-color); font-size: 1.6rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; transition: color 0.3s ease, border-color 0.3s ease; }
        .dark-mode .modal-content h3 { border-bottom-color: #40444B; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .modal-buttons button { padding: 10px 18px; font-size: 0.95rem; font-weight: 600; border-radius: 5px; border: none; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; }
        .modal-buttons button:active { transform: scale(0.98); } 
        .modal-buttons button.primary { background-color: var(--button-primary-bg); color: var(--button-primary-text-color); }
        .modal-buttons button.primary:hover { background-color: var(--button-primary-hover-bg); }
        .modal-buttons button.cancel { background-color: #6c757d; color: var(--button-primary-text-color); }
        .modal-buttons button.cancel:hover { background-color: #5a6268; }

        .notification-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 2000; max-width: 320px; }
        .notification { background-color: var(--header-gradient-start); color: var(--button-primary-text-color); padding: 14px 22px; border-radius: 6px; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); opacity: 0; transform: translateX(100%); animation: slideInFadeIn 0.4s ease-out forwards; }
        .notification.error { background-color: var(--danger-color); } 
        @keyframes slideInFadeIn { to { opacity: 1; transform: translateX(0); } } 
        @keyframes fadeOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .notification.fade-out { animation: fadeOutRight 0.4s ease-out forwards; }

        @media (max-width: 992px) {
            .top-header-content h1 { font-size: 1.7rem; }
            .tools-title { font-size: 1.6rem; } #program-menu { grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); }
            .modal-content { padding: 20px; max-width: 90%; } .modal-content h3 { font-size: 1.4rem; }
            .modal-buttons { flex-direction: column; gap: 8px; } .modal-buttons button { width: 100%; }
        }
        @media (max-width: 576px) {
            .top-header-content h1 { font-size: 1.5rem; }
            .tools-title { font-size: 1.4rem; }
            #program-menu { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .program-item { padding: 15px 10px; min-height: 120px; } .program-item .item-icon { font-size: 2rem; margin-bottom: 8px;} .program-item .item-title { font-size: 0.9rem; }
        }
    </style>
</head>
<body> 
    <canvas id="particleCanvas"></canvas>
    <div class="area" id="floatingBoxesArea"><ul class="circles" id="floatingBoxesList"></ul></div>

    <div class="top-header-wrapper">
        <div class="top-header-content">
            <h1>Azure DevOps Insights Tool</h1>
            <button id="dark-mode-toggle" aria-label="Toggle Dark Mode">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM5.64 18.36c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.41 1.41zm12.73-12.73c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.41 1.41z"/></svg>
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.8 4.8 5 8.3 5 12.5c0 4.4 3.6 8 8 8 3.7 0 6.8-2.5 7.8-6c.2-.4 0-.9-.4-1.1s-.9 0-1.1.4c-.8 2.3-3 4-5.4 4-3.3 0-6-2.7-6-6 0-2.9 2.1-5.4 5-5.9z"/></svg>
            </button>
        </div>
    </div>

    <div class="container">
        <h2 class="tools-title">Tools</h2>
        <div id="programs-section" class="content-section"><div id="program-menu"></div></div>
        <div id="program-explanation"><p>Hover over a program card above to see its explanation here.</p></div>
    </div>

    <div id="batch-count-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Batch Count Calculator Options</h3>
            <div class="modal-buttons" style="flex-direction: column; align-items: stretch;">
                <button id="batch-count-highest-btn" class="primary">Batch Count Highest Round</button>
                <button id="batch-count-nearest-btn" class="primary" style="margin-top:10px;">Batch Count Nearest Round</button>
                <button class="cancel" id="cancel-batch-count-btn" style="margin-top:20px;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="notification-container" class="notification-container"></div>

    <script>
        // --- Global Variables & DOM Element References ---
        const programExplanation = document.getElementById('program-explanation');
        const programMenu = document.getElementById('program-menu');
        const batchCountModal = document.getElementById('batch-count-modal');
        const batchCountHighestBtn = document.getElementById('batch-count-highest-btn');
        const batchCountNearestBtn = document.getElementById('batch-count-nearest-btn');
        const cancelBatchCountBtn = document.getElementById('cancel-batch-count-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // --- Background Visualizer DOM Elements ---
        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas.getContext('2d');
        const floatingBoxesArea = document.getElementById('floatingBoxesArea');
        const floatingBoxesList = document.getElementById('floatingBoxesList');

        // --- State and Constants ---
        const NOTIFICATION_FADE_DURATION = 400;
        const DARK_MODE_STORAGE_KEY = 'adoInsightsToolDarkMode_v1';

        // --- Background Visualizer Default Settings & Data ---
        const visualizerSettings = {
            particleCount: 150, particleSpeedFactor: 0.5, maxParticleSize: 3.0, particleColorScheme: 'vibrant', showLines: true, lineMaxDistance: 80, wrapParticles: true,
            mouseRepelEnabled: true, mouseRepelRadius: 100,
            floatingBoxesEnabled: true, boxCount: 15, minBoxSize: 20, maxBoxSize: 120, boxOpacity: 0.4, boxAnimationScale: 1.0, boxColorMode: 'gradient_custom', boxSolidColor1: '#6A0DAD', boxGradientColor1: '#9600ff', boxGradientColor2: '#ffc864', boxGradientDirection: '45deg', boxShadowsEnabled: true, boxBorderEnabled: false, boxBorderWidth: 2, boxBorderColor: '#FFFFFF',
        };
        const particleColorPalettes = {
            vibrant: ['#6A0DAD', '#8A2BE2', '#FFA500', '#FFDAB9', '#FFFFFF'], cool: ['#0077BE', '#00AADE', '#73C2FB', '#BCE3FF', '#FFFFFF'], warm: ['#D22B2B', '#FF8C00', '#FFD700', '#FFFACD', '#FFE4B5'], forest: ['#228B22', '#556B2F', '#8FBC8F', '#90EE90', '#F5F5DC'], monochrome_particles: ['#333333', '#666666', '#999999', '#CCCCCC', '#FFFFFF']
        };
        
        let particlesArray = [];
        const mouseForParticles = { x: null, y: null, radius: 100 };
        let animationFrameIdVisualizer;

        const programs = [ 
            { id: 'parameter-extractor', name: 'Parameter Extractor', icon: 'üõ†Ô∏è', description: "Extracts URL parameters from various Azure Function JSON payloads.", file: 'Tools/parameter_tool.html' }, 
            { id: 'batch-count-calculator', name: 'Batch Count Calculator', icon: 'üßÆ', description: "Calculate batch sizes. Opens options modal.", modal: batchCountModal }, 
            { id: 'csv-to-json-processor', name: 'CSV to JSON Processor', icon: 'üìÑ', description: "Filters CSV data and converts it to structured JSON.", file: 'csv-to-json-tool/'},
            { id: 'tool-4', name: 'Tool 4 (Future)', icon: '‚öôÔ∏è', description: "This tool isn't implemented yet.", file: '#'}, 
            { id: 'tool-5', name: 'Tool 5 (Future)', icon: '‚öôÔ∏è', description: "This tool isn't implemented yet.", file: '#'} 
        ];
        
        function createProgramCard(item) { const isLink = item.file && item.file !== '#'; const card = document.createElement(isLink ? 'a' : 'div'); card.className = 'program-item'; card.id = `${item.id}-card`; let fullDesc = item.description; if (isLink) { card.href = item.file; card.target = '_blank'; card.rel = 'noopener noreferrer'; fullDesc = `Launches the ${item.name}. ${item.description}`; } else if (item.modal) { card.addEventListener('click', () => showModal(item.modal)); fullDesc = `Opens the ${item.name}. ${item.description}`; } else if (item.file === '#') { card.style.cursor = 'not-allowed'; card.addEventListener('click', (e) => { e.preventDefault(); showNotification(`"${item.name}" is not yet implemented.`, 3000, 'info'); }); } card.innerHTML = `<span class="item-icon">${item.icon || '‚≠ê'}</span><span class="item-title">${item.name}</span>`; card.addEventListener('mouseover', () => { programExplanation.textContent = fullDesc; programExplanation.classList.add('active'); }); card.addEventListener('mouseout', () => { programExplanation.innerHTML = '<p>Hover over a program card above to see its explanation here.</p>'; programExplanation.classList.remove('active'); }); return card; }
        function populateMenus() { programMenu.innerHTML = ''; programs.forEach(prog => programMenu.appendChild(createProgramCard(prog)));}

        function hexToRgb(hex) { const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i; hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b); const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null; }
        
        // --- Background Visualizer Functions ---
        const boxBackgroundFunctions = {
            'theme_boxes': (i) => (i % 2 === 0) ? 'rgb(106, 13, 173)' : 'rgb(255, 165, 0)',
            'monochrome_boxes': () => { const gray = Math.floor(Math.random() * 55) + 200; return `rgb(${gray},${gray},${gray})`; },
            'solid_custom': () => visualizerSettings.boxSolidColor1,
            'gradient_custom': () => `linear-gradient(${visualizerSettings.boxGradientDirection}, ${visualizerSettings.boxGradientColor1}, ${visualizerSettings.boxGradientColor2})`
        };

        class Particle { 
            constructor(x, y, dX, dY, size, color) { this.x = x; this.y = y; this.dX = dX; this.dY = dY; this.size = size; this.color = color;}
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
            update() {
                if (visualizerSettings.wrapParticles) {
                    if (this.x > particleCanvas.width + this.size) this.x = -this.size; else if (this.x < -this.size) this.x = particleCanvas.width + this.size;
                    if (this.y > particleCanvas.height + this.size) this.y = -this.size; else if (this.y < -this.size) this.y = particleCanvas.height + this.size;
                } else {
                    if (this.x + this.size > particleCanvas.width || this.x - this.size < 0) this.dX *= -1;
                    if (this.y + this.size > particleCanvas.height || this.y - this.size < 0) this.dY *= -1;
                }
                if (visualizerSettings.mouseRepelEnabled && mouseForParticles.x !== undefined && mouseForParticles.y !== undefined) {
                    let dx = mouseForParticles.x - this.x; let dy = mouseForParticles.y - this.y; let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < mouseForParticles.radius) { let fdx=dx/dist, fdy=dy/dist, force=(mouseForParticles.radius-dist)/mouseForParticles.radius; this.x -= fdx*force*5; this.y -= fdy*force*5; }
                }
                this.x += this.dX * visualizerSettings.particleSpeedFactor; this.y += this.dY * visualizerSettings.particleSpeedFactor; this.draw();
            }
        }
        function initParticles() {
            particlesArray = []; 
            const palette = particleColorPalettes[visualizerSettings.particleColorScheme] || particleColorPalettes.vibrant;
            for (let i = 0; i < visualizerSettings.particleCount; i++) {
                let size = Math.random() * visualizerSettings.maxParticleSize + 1;
                let x = Math.random() * (particleCanvas.width - size * 2) + size, y = Math.random() * (particleCanvas.height - size * 2) + size;
                let dX = (Math.random()*2-1), dY = (Math.random()*2-1), color = palette[Math.floor(Math.random()*palette.length)];
                particlesArray.push(new Particle(x, y, dX, dY, size, color));
            }
        }
        function connectParticles() {
            if (!visualizerSettings.showLines) return;
            const lineColorPalette = particleColorPalettes[visualizerSettings.particleColorScheme] || particleColorPalettes.vibrant;
            const baseLineColorHex = lineColorPalette[0] || '#6A0DAD'; 
            const rgb = hexToRgb(baseLineColorHex);
            if (!rgb) return;
            const [r,g,b_val] = rgb;

            for (let a = 0; a < particlesArray.length; a++) {
                for (let b_loop = a + 1; b_loop < particlesArray.length; b_loop++) {
                    let dx = particlesArray[a].x - particlesArray[b_loop].x;
                    let dy = particlesArray[a].y - particlesArray[b_loop].y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < visualizerSettings.lineMaxDistance) {
                        let opacity = 1 - (dist / visualizerSettings.lineMaxDistance);
                        ctx.strokeStyle = `rgba(${r},${g},${b_val}, ${opacity*0.5})`;
                        ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b_loop].x, particlesArray[b_loop].y); ctx.stroke();
                    }
                }
            }
        }
        function generateFloatingBoxes() {
            floatingBoxesList.innerHTML = ''; 
            if (!visualizerSettings.floatingBoxesEnabled) {
                floatingBoxesArea.style.display = 'none';
                return;
            }
            floatingBoxesArea.style.display = 'block';
            const baseDuration = 25;
            for (let i = 0; i < visualizerSettings.boxCount; i++) {
                const li = document.createElement('li');
                const size = Math.random() * (visualizerSettings.maxBoxSize - visualizerSettings.minBoxSize) + visualizerSettings.minBoxSize;
                Object.assign(li.style, {
                    width: `${size}px`, height: `${size}px`, left: `${Math.random() * 90}%`, opacity: visualizerSettings.boxOpacity,
                    background: (boxBackgroundFunctions[visualizerSettings.boxColorMode] || boxBackgroundFunctions['theme_boxes'])(i),
                    animationDuration: `${(Math.random() * 10 + (baseDuration - 5)) / visualizerSettings.boxAnimationScale}s`,
                    animationDelay: `${Math.random() * baseDuration / visualizerSettings.boxAnimationScale}s`,
                    boxShadow: visualizerSettings.boxShadowsEnabled ? `3px 3px 10px rgba(0, 0, 0, ${visualizerSettings.boxOpacity > 0.5 ? 0.2 : 0.15})` : 'none',
                    border: visualizerSettings.boxBorderEnabled ? `${visualizerSettings.boxBorderWidth}px solid ${visualizerSettings.boxBorderColor}` : 'none'
                });
                floatingBoxesList.appendChild(li);
            }
        }
        function animateVisualizer() { 
            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update();
            connectParticles(); 
            animationFrameIdVisualizer = requestAnimationFrame(animateVisualizer);
        }
        function startOrRestartVisualizer() {
            if (animationFrameIdVisualizer) {
                cancelAnimationFrame(animationFrameIdVisualizer);
            }
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
            initParticles();
            generateFloatingBoxes();
            animateVisualizer();
        }

        function showModal(modalElement) { if (modalElement) modalElement.classList.add('visible'); }
        function hideModal(modalElement) { if (modalElement) modalElement.classList.remove('visible'); }

        batchCountHighestBtn.addEventListener('click', () => { window.open('Tools/Batchcountcalculator/batchcount_calculator-highestround.html', '_blank', 'noopener,noreferrer'); hideModal(batchCountModal); });
        batchCountNearestBtn.addEventListener('click', () => { window.open('Tools/Batchcountcalculator/batchcount_calculator-nearestround.html', '_blank', 'noopener,noreferrer'); hideModal(batchCountModal); });
        cancelBatchCountBtn.addEventListener('click', () => hideModal(batchCountModal));
        
        [batchCountModal].forEach(modal => { if (modal) { modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(modal); });}});
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (batchCountModal && batchCountModal.classList.contains('visible')) hideModal(batchCountModal); }});
        
        function showNotification(message, duration = 3000, type = 'info') { const container = document.getElementById('notification-container'); if (!container) { console.warn("Notification container not found."); return; } const notification = document.createElement('div'); notification.className = 'notification'; if (type === 'error') notification.classList.add('error'); notification.textContent = message; container.appendChild(notification); setTimeout(() => { notification.classList.add('fade-out'); notification.addEventListener('animationend', () => notification.remove(), { once: true }); }, duration - NOTIFICATION_FADE_DURATION); }
        
        // --- Dark Mode Logic ---
        function applyDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        darkModeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem(DARK_MODE_STORAGE_KEY, isDarkMode);
        });

        // --- Initial Load ---
        window.addEventListener('mousemove', e => { mouseForParticles.x = e.clientX; mouseForParticles.y = e.clientY; });
        window.addEventListener('mouseout', () => { mouseForParticles.x = undefined; mouseForParticles.y = undefined; });
        window.addEventListener('resize', startOrRestartVisualizer);
        
        document.addEventListener('DOMContentLoaded', () => { 
            // Load Dark Mode Preference
            const savedDarkMode = localStorage.getItem(DARK_MODE_STORAGE_KEY) === 'true';
            applyDarkMode(savedDarkMode);

            populateMenus(); 
            startOrRestartVisualizer();
        });

    </script>
</body>
</html>
