<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to JSON [Release Environments]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #dropZone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #dropZone.dragover {
            background-color: #e0f2fe; /* light sky blue */
            border-color: #0ea5e9; /* sky blue */
        }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #555; }
        .input-label { font-weight: 500; margin-bottom: 0.25rem; display: block; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white p-6 md:p-8 rounded-xl shadow-2xl relative">
        <header class="mb-8 text-center">
            <a href="../" title="Back to Home" class="absolute top-4 left-4 text-2xl">üè†</a>
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">CSV to Structured JSON Tool</h1>
            <p class="text-slate-600 mt-2">Select a tenant, then drop a CSV. The tool will automatically generate clean, deduplicated JSON.</p>
        </header>

        <section class="mb-6 p-4 border border-slate-300 rounded-lg bg-slate-50">
            <h2 class="text-xl font-semibold mb-3 text-sky-700">Configuration</h2>
            <div>
                <label for="tenantSelect" class="input-label text-slate-700">Tenant:</label>
                <select id="tenantSelect" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    <option value="">-- Select Tenant --</option>
                    <option value="accenturecio04">accenturecio04</option>
                    <option value="accenturecio05">accenturecio05</option>
                    <option value="accenturecio07">accenturecio07</option>
                    <option value="accenturecio08">accenturecio08</option>
                    <option value="accenturecio11">accenturecio11</option>
                    <option value="accenturecio12">accenturecio12</option>
                    <option value="accenturecio20">accenturecio20</option>
                    <option value="accenturecio22">accenturecio22</option>
                    <option value="accenturecio23">accenturecio23</option>
                    <option value="accenturecio24">accenturecio24</option>
                    <option value="accenturecio25">accenturecio25</option>
                    <option value="accenturecio26">accenturecio26</option>
                    <option value="accenturecio27">accenturecio27</option>
                </select>
            </div>
        </section>

        <section class="mb-6">
            <div id="dropZone" class="border-2 border-dashed border-slate-400 rounded-lg p-8 md:p-12 text-center cursor-pointer hover:border-sky-500">
                <p class="text-slate-600 text-lg">Drag & Drop your CSV File Here</p>
                <p class="text-sm text-slate-500 mt-1">or</p>
                <input type="file" id="fileInput" accept=".csv" class="block w-full max-w-xs mx-auto mt-2 text-sm text-slate-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-sky-50 file:text-sky-700
                    hover:file:bg-sky-100">
                <div id="fileInfo" class="mt-3 text-sm text-slate-500"></div>
            </div>
        </section>

        <section class="mb-6">
            <label for="outputBox" class="input-label text-slate-700">Output Area:</label>
            <textarea id="outputBox" placeholder="1. Select a Tenant.&#10;2. Drop a CSV file.&#10;3. Formatted, unique JSON will appear here automatically."
                        class="w-full h-64 md:h-96 p-3 border border-slate-300 rounded-md bg-slate-50 font-mono text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"></textarea>
        </section>

        <section class="flex flex-wrap gap-3 justify-center">
            <button id="saveButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                Save as .txt
            </button>
            <button id="copyButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                Copy Output
            </button>
            <button id="resetButton" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                Reset All
            </button>
        </section>

        <div id="messageArea" class="mt-6 text-center text-sm"></div>
    </div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const outputBox = document.getElementById('outputBox');
    const fileInfoDiv = document.getElementById('fileInfo');
    const tenantSelect = document.getElementById('tenantSelect');
    const saveButton = document.getElementById('saveButton');
    const copyButton = document.getElementById('copyButton');
    const resetButton = document.getElementById('resetButton');
    const messageArea = document.getElementById('messageArea');

    function parseCsvRow(rowString) {
        const values = [];
        let inQuotes = false;
        let currentValue = '';
        for (let i = 0; i < rowString.length; i++) {
            const char = rowString[i];
            if (char === '"') {
                if (inQuotes && i + 1 < rowString.length && rowString[i+1] === '"') {
                    currentValue += '"'; 
                    i++; 
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                values.push(currentValue.trim());
                currentValue = '';
            } else {
                currentValue += char;
            }
        }
        values.push(currentValue.trim());
        return values;
    }

    function handleFile(file) {
        if (!file || !file.type.match('text/csv') && !file.name.endsWith('.csv')) {
            showMessage('Please drop or select a valid CSV file.', 'error');
            return;
        }

        const selectedTenant = tenantSelect.value;
        if (!selectedTenant) {
            showMessage('Please select a Tenant from the dropdown before processing a file.', 'error');
            fileInput.value = null; 
            return;
        }

        fileInfoDiv.textContent = `Processing: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        outputBox.value = ''; 
        showMessage('Reading and processing CSV file...', 'info');

        const reader = new FileReader();
        reader.onload = (e) => {
            const csvString = e.target.result;
            processCsvData(csvString);
        };
        reader.onerror = () => {
            showMessage('Error reading file.', 'error');
            fileInfoDiv.textContent = 'Error reading file.';
        };
        reader.readAsText(file);
    }

    dropZone.addEventListener('dragover', (event) => { event.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropZone.classList.remove('dragover');
        if (event.dataTransfer.files.length) handleFile(event.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (event) => { if (event.target.files.length) handleFile(event.target.files[0]); });

    function toNumeric(value) {
        if (value === null || value === '') return value;
        const num = Number(value);
        return isNaN(num) ? value : num;
    }

    function processCsvData(csvString) {
        const lines = csvString.split(/\r\n|\r|\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) {
            showMessage('CSV file needs at least a header and one data row.', 'error');
            return;
        }

        const headerLine = lines.shift();
        const headers = parseCsvRow(headerLine);

        const statusColumnIndex = 10;
        const processValue = 'missing';
        const selectedTenant = tenantSelect.value;

        if (headers.length < 11) { 
            showMessage('CSV needs at least 11 columns (up to Column K) for the tool to work.', 'error');
            return;
        }

        const processedObjects = [];
        lines.forEach(line => {
            const values = parseCsvRow(line);
            if (values.length > statusColumnIndex && values[statusColumnIndex] && values[statusColumnIndex].trim().toLowerCase() === processValue) {
                if (values.length >= 3) { 
                    const param1Val = values[0] ? values[0].trim() : "";
                    const param2Val = values[2] ? values[2].trim() : ""; 
                    let param3Val = "";

                    const underscoreIndex = param1Val.lastIndexOf('_');
                    if (underscoreIndex !== -1 && underscoreIndex < param1Val.length - 1) {
                        param3Val = param1Val.substring(underscoreIndex + 1);
                    }

                    const obj = {
                        "tenant": selectedTenant,
                        "param1": param1Val,
                        "param2": toNumeric(param2Val),
                        "param3": toNumeric(param3Val)
                    };
                    processedObjects.push(obj);
                }
            }
        });

        const uniqueObjects = [];
        const seenSignatures = new Set();
        processedObjects.forEach(obj => {
            const signature = JSON.stringify(obj); 
            if (!seenSignatures.has(signature)) {
                seenSignatures.add(signature);
                uniqueObjects.push(obj);
            }
        });

        const finalOutputString = uniqueObjects.map(obj => JSON.stringify(obj, null, 2)).join(',\n') + (uniqueObjects.length > 0 ? ',' : '');
        outputBox.value = finalOutputString;
        outputBox.scrollTop = 0; 

        showMessage(`Processing complete. Found ${uniqueObjects.length} unique JSON objects.`, 'success');
    }

    saveButton.addEventListener('click', () => {
        const textToSave = outputBox.value;
        const selectedTenant = tenantSelect.value;

        if (textToSave.trim() === "") {
            showMessage("Output box is empty. Nothing to save.", 'info');
            return;
        }

        if (!selectedTenant) {
            showMessage("Please select a Tenant first to name the file.", 'error');
            return;
        }

        const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${selectedTenant}_output.txt`; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        showMessage('File download initiated.', 'success');
    });

    copyButton.addEventListener('click', () => {
        if (outputBox.value.trim() === "") {
            showMessage("Output box is empty. Nothing to copy.", 'info'); return;
        }
        navigator.clipboard.writeText(outputBox.value)
            .then(() => showMessage('Output copied to clipboard!', 'success'))
            .catch(err => {
                showMessage('Failed to copy output. See console for details.', 'error'); 
                console.error('Error copying to clipboard: ', err);
            });
    });

    resetButton.addEventListener('click', () => {
        outputBox.value = '';
        fileInfoDiv.textContent = '';
        fileInput.value = null; 
        tenantSelect.value = ""; 
        showMessage('Tool has been reset.', 'info');
    });

    function showMessage(message, type = 'info') {
        messageArea.textContent = message;
        messageArea.className = 'mt-6 text-center text-sm p-2 rounded-md transition-opacity duration-300'; 
        if (type === 'success') messageArea.classList.add('bg-emerald-100', 'text-emerald-700');
        else if (type === 'error') messageArea.classList.add('bg-rose-100', 'text-rose-700');
        else messageArea.classList.add('bg-sky-100', 'text-sky-700');

        setTimeout(() => {
            if (messageArea.textContent === message) {
                messageArea.classList.add('opacity-0');
            }
        }, 7000);
    }
</script>

</body>
</html>
