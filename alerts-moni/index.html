<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell Script Viewer</title>
    <link href="https://fonts.googleapis.com/css?family=Exo:400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Root Variables for Theming */
        :root {
            /* Default (Light) Theme Colors */
            --header-gradient-start: #4A0082;
            --header-gradient-end: #D4529D;
            --header-gradient-angle: 105deg;
            --header-main-title-color: #FFFFFF;
            --page-bg-color: #F8F9FA;
            --card-bg-color: #FFFFFF;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-border-radius: 16px;
            --text-color: #222;
            --text-color-light: #555;
            --border-color: #e0e0e0;
            --input-bg: rgba(255, 255, 255, 0.5);
            --input-border-color: #d1d5db;
            --input-text-color: #374151;
            --accent-color: #8A3DAF;
            --accent-color-light: rgba(138, 61, 175, 0.1);
            --toggle-icon-fill: #FFFFFF;
        }

        body.dark-mode {
            --header-gradient-start: #23272A;
            --header-gradient-end: #5865F2;
            --page-bg-color: #2C2F33;
            --card-bg-color: #23272A;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --text-color: #f3f4f6;
            --text-color-light: #9ca3af;
            --border-color: #4b5563;
            --input-bg: rgba(20, 20, 20, 0.3);
            --input-border-color: #4b5563;
            --input-text-color: #f3f4f6;
            --accent-color: #a78bfa;
            --accent-color-light: rgba(167, 139, 250, 0.15);
        }

        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', 'Exo', sans-serif;
            background-color: var(--page-bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1.6;
        }

        /* Header Styles */
        .top-header-wrapper {
            background: linear-gradient(var(--header-gradient-angle), var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-main-title-color);
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .top-header-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .top-header-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .home-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--header-main-title-color);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #dark-mode-toggle {
            background: none;
            border: none;
            color: var(--toggle-icon-fill);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: transform 0.3s ease-in-out, background-color 0.2s ease;
        }

        #dark-mode-toggle svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            transition: transform 0.4s ease;
        }

        #dark-mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .sun-icon { display: none; }
        .dark-mode .sun-icon { display: block; }
        .dark-mode .moon-icon { display: none; }

        /* Main Content Styles */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            min-height: calc(100vh - 75px);
        }

        .code-viewer-container {
            width: 100%;
            max-width: 56rem;
            background: var(--card-bg-color);
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 75px - 4rem);
        }

        .code-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .language-tag {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color-light);
        }

        .copy-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 1rem;
            background-color: var(--page-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .copy-button:hover {
            background-color: var(--accent-color-light);
        }

        .code-block-wrapper {
            padding: 1.5rem;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        
        pre {
           white-space: pre-wrap;
           word-wrap: break-word;
        }

    </style>
</head>
<body>

    <div class="top-header-wrapper">
        <div class="top-header-content">
            <div class="header-left">
                <a href="#" class="home-button" onclick="alert('This would return to the main page.');">Home</a>
                <h1>Automated Alerts Monitoring via Webhooks</h1>
            </div>
            <button id="dark-mode-toggle" aria-label="Toggle Dark Mode">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM5.64 18.36c.39.39.39 1.02 0 1.41-.39.39-1.02-.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.41 1.41zm12.73-12.73c.39.39.39 1.02 0 1.41-.39.39-1.02-.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.41 1.41z"/></svg>
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.8 4.8 5 8.3 5 12.5c0 4.4 3.6 8 8 8 3.7 0 6.8-2.5 7.8-6c.2-.4 0-.9-.4-1.1s-.9 0-1.1.4c-.8 2.3-3 4-5.4 4-3.3 0-6-2.7-6-6 0-2.9 2.1-5.4 5-5.9z"/></svg>
            </button>
        </div>
    </div>

    <main class="main-container">
        <div class="code-viewer-container">
            <div class="code-viewer-header">
                <span class="language-tag">PowerShell</span>
                <button id="copyButton" class="copy-button">Copy Script</button>
            </div>
            <div class="code-block-wrapper">
                <pre><code id="code-block">
# Set variables
# Please replace the csv path based on the exported path in your local
$csvPaths = @(
    "C:\Users\melamar.faustino\Downloads\adf-18915601pdevarchinsights_Pipeline runs (2).csv"
)
# Note: Csv files can be multiple just add a comma if you want to add more

$webhookUrl = "https://accenture.webhook.office.com/webhookb2/7185bf44-2c01-4a5a-bd71-01a9cda30171@e0793d39-0939-496d-b129-198edd916feb/IncomingWebhook/64d28fcae0144366ae69f59b01705d4d/6e8ac95c-6694-4b54-8419-8942f9395f3a/V2tYYhFkrIWEzLMJEIuYEdDuAUWdB1E3H8lMnSoSnjOVU1"

# Load and combine CSVs
$failedPipelines = foreach ($path in $csvPaths) {
    Import-Csv -Path $path
}

# Filter only failed pipelines
$failedOnly = $failedPipelines | Where-Object { $_.'Status' -eq 'Failed' }

# Get unique failure dates
$failureDates = $failedOnly |
    ForEach-Object { [datetime]::Parse($_.'Run start').Date } |
    Sort-Object -Descending |
    Get-Unique

# Prompt user to select multiple dates
Write-Host "`nDetected the following failure dates:`n"
for ($i = 0; $i -lt $failureDates.Count; $i++) {
    Write-Host "$($i + 1): $($failureDates[$i].ToString('MMMM dd, yyyy (dddd)'))"
}

$selectionInput = Read-Host "`nEnter the numbers of the dates you'd like to process (comma-separated, e.g., 1,3,5)"
$selectedIndexes = $selectionInput -split ',' | ForEach-Object { ($_ -as [int]) - 1 }

# Validate and get selected dates
$selectedDates = $selectedIndexes | Where-Object { $_ -ge 0 -and $_ -lt $failureDates.Count } | ForEach-Object { $failureDates[$_] }

Write-Host "`nYou selected the following dates:`n"
$selectedDates | ForEach-Object { Write-Host "• $($_.ToString('MMMM dd, yyyy (dddd)'))" }

# Filter pipelines for selected dates
$groupedByDate = $failedOnly |
    Where-Object { $selectedDates -contains ([datetime]::Parse($_.'Run start').Date) } |
    Group-Object { [datetime]::Parse($_.'Run start').Date } |
    Sort-Object Name -Descending

# Start message
$message = "🌞 Hi Team!`n`n`n"

# Build message per date group
foreach ($group in $groupedByDate) {
    $date = [datetime]$group.Name
    $formattedDate = $date.ToString("MMMM dd, yyyy (dddd)")
    $message += "**📅 Failed Pipelines Report – $formattedDate**`n`n"
    $message += "```````n"

    # Filter Transform_DimFact and Transform_ALM failures
    $detailedFailures = $group.Group | Where-Object { $_.'Pipeline name' -like "*Transform_DimFact*" -or $_.'Pipeline name' -like "*Transform_ALM*" }

    if ($detailedFailures.Count -eq 0) {
        $message += "✅ No Transform_DimFact or Transform_ALM failures found for this date.`n`n"
    } else {
        foreach ($pipeline in $detailedFailures) {
            $pipelineName = $pipeline.'Pipeline name'
            $errorMessage = $pipeline.'Error'

            # Extract brief error
            if ($errorMessage -match "^(.*?failed)([:\\.])") {
                $briefError = "$($Matches[1])."
            } else {
                $briefError = $errorMessage
            }

            # Extract error code
            $errorCode = ""
            if ($errorMessage -match "ErrorCode=([A-Za-z0-9]+)") {
                $errorCode = "ErrorCode=" + $Matches[1]
            }

            # Format message
            $message += "❌ $pipelineName`n"
            $message += "     ⚠️ Error: $briefError`n"
            if ($errorCode) {
                $message += "          🧾 $errorCode`n"
            }
            $message += "`n"
        }
    }

    # Format _inner failures as a table
    $innerFailures = $group.Group | Where-Object { $_.'Pipeline name' -like "*_inner*" }
    if ($innerFailures.Count -gt 0) {
        $innerGrouped = $innerFailures | Group-Object 'Pipeline name'

        $message += "Pipeline Name".PadRight(50) + "Failed Count`n"
        $message += "-" * 65 + "`n"

        foreach ($entry in $innerGrouped) {
            $line = $entry.Name.PadRight(50) + "= " + $entry.Count
            $message += "$line`n"
        }
    }

    $message += "```````n`n"
}

# If no failures found
if ($groupedByDate.Count -eq 0) {
    $message += "**📅 Failed Pipelines Report – No failed pipelines found.**`n"
}

# Send to MS Teams
$payload = @{ text = $message } | ConvertTo-Json -Depth 3
$utf8Bytes = [System.Text.Encoding]::UTF8.GetBytes($payload)
Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $utf8Bytes -ContentType 'application/json'

                </code></pre>
            </div>
        </div>
    </main>

<script>
    // --- DOM Element References ---
    const copyButton = document.getElementById('copyButton');
    const codeBlock = document.getElementById('code-block');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const DARK_MODE_STORAGE_KEY = 'adoInsightsToolDarkMode_v1';

    // --- Dark Mode Logic ---
    function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
    }

    darkModeToggle.addEventListener('click', () => {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem(DARK_MODE_STORAGE_KEY, isDarkMode);
    });
    
    // --- Copy Logic ---
    copyButton.addEventListener('click', () => {
        const textToCopy = codeBlock.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    });

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        applyDarkMode(localStorage.getItem(DARK_MODE_STORAGE_KEY) === 'true');
    });
</script>

</body>
</html>
